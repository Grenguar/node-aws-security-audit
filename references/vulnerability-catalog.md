# Node.js Vulnerability Catalog

Reference for each OWASP Top 10:2021 category with Node.js-specific grep patterns,
vulnerable code examples, and secure alternatives.

---

## A01 — Broken Access Control

### Grep patterns

```bash
# Missing auth middleware on routes
grep -rnE "(app|router)\.(get|post|put|patch|delete)\s*\(" --include="*.{js,ts,mjs}" | grep -v "auth\|protect\|guard\|middleware\|verify\|session"

# Insecure Direct Object Reference (IDOR)
grep -rnE "req\.(params|query)\.(id|userId|accountId)" --include="*.{js,ts}"

# Permissive CORS
grep -rnE "origin:\s*['\"]?\*['\"]?" --include="*.{js,ts}"
grep -rnE "Access-Control-Allow-Origin.*\*" --include="*.{js,ts}"

# Missing role checks
grep -rnE "req\.user\.(role|isAdmin)" --include="*.{js,ts}"
```

### Vulnerable

```javascript
// IDOR — user can access any record by changing the ID
app.get('/api/invoices/:id', authenticate, async (req, res) => {
  const invoice = await Invoice.findById(req.params.id);
  res.json(invoice);
});
```

### Secure

```javascript
app.get('/api/invoices/:id', authenticate, async (req, res) => {
  const invoice = await Invoice.findOne({
    _id: req.params.id,
    owner: req.user._id,   // scope to authenticated user
  });
  if (!invoice) return res.status(404).json({ error: 'Not found' });
  res.json(invoice);
});
```

---

## A02 — Cryptographic Failures

### Grep patterns

```bash
# Hardcoded secrets/keys
grep -rnE "(password|secret|api_key|apiKey|token|JWT_SECRET)\s*[:=]\s*['\"][^'\"]{4,}" --include="*.{js,ts}" | grep -v node_modules | grep -v "\.test\.\|\.spec\.\|__test__"

# Weak hashing
grep -rnE "createHash\(\s*['\"]md5['\"]|createHash\(\s*['\"]sha1['\"]" --include="*.{js,ts}"

# No HTTPS enforcement
grep -rnE "http://" --include="*.{js,ts}" | grep -v "localhost\|127\.0\.0\.1\|node_modules"

# Missing encryption on sensitive data
grep -rnE "\.create\(|\.save\(" --include="*.{js,ts}" | grep -i "password\|ssn\|creditCard"
```

### Vulnerable

```javascript
// Hardcoded JWT secret and weak hashing
const jwt = require('jsonwebtoken');
const crypto = require('crypto');

const JWT_SECRET = 'mysupersecret123';

function hashPassword(pw) {
  return crypto.createHash('md5').update(pw).digest('hex');
}
```

### Secure

```javascript
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');

const JWT_SECRET = process.env.JWT_SECRET; // from env

async function hashPassword(pw) {
  return bcrypt.hash(pw, 12); // bcrypt with cost 12
}
```

---

## A03 — Injection

### Grep patterns

```bash
# eval / Function constructor
grep -rnE "\beval\s*\(|new\s+Function\s*\(" --include="*.{js,ts}"

# vm module — sandbox escape
grep -rnE "require\(['\"]vm['\"]\)|vm\.(runInNewContext|runInThisContext|createScript|compileFunction)" --include="*.{js,ts}"

# Command injection
grep -rnE "child_process|exec\(|execSync\(|spawn\(|execFile\(" --include="*.{js,ts}"

# SQL injection — string concatenation in queries
grep -rnE "(query|execute)\s*\(\s*['\`].*\+\s*req\." --include="*.{js,ts}"
grep -rnE "\$\{req\.(body|query|params)" --include="*.{js,ts}"

# NoSQL injection
grep -rnE "\.find\(\s*\{.*req\.(body|query|params)" --include="*.{js,ts}"
grep -rnE "\\\$where|\\\$gt|\\\$ne|\\\$regex" --include="*.{js,ts}"

# Template injection
grep -rnE "\.render\(.*req\.(body|query)" --include="*.{js,ts}"
```

### Vulnerable

```javascript
// SQL injection via template literal
app.get('/users', async (req, res) => {
  const result = await db.query(
    `SELECT * FROM users WHERE name = '${req.query.name}'`
  );
  res.json(result.rows);
});

// Command injection
app.get('/ping', (req, res) => {
  exec(`ping -c 1 ${req.query.host}`, (err, stdout) => {
    res.send(stdout);
  });
});
```

### Secure

```javascript
// Parameterized query
app.get('/users', async (req, res) => {
  const result = await db.query(
    'SELECT * FROM users WHERE name = $1',
    [req.query.name]
  );
  res.json(result.rows);
});

// Validated input, no shell
const { isIP } = require('net');
app.get('/ping', (req, res) => {
  const host = req.query.host;
  if (!isIP(host)) return res.status(400).json({ error: 'Invalid IP' });
  execFile('ping', ['-c', '1', host], (err, stdout) => {
    res.send(stdout);
  });
});
```

---

## A04 — Insecure Design

### Grep patterns

```bash
# Mass assignment — passing req.body directly to model
grep -rnE "\.(create|update|findOneAndUpdate|updateOne|updateMany)\(\s*req\.body" --include="*.{js,ts}"

# Missing rate limiting
grep -rnE "express-rate-limit|rateLimit|rate-limiter" --include="*.{js,ts}" package.json

# No input validation schema
grep -rnE "joi|zod|yup|ajv|express-validator|class-validator" package.json
```

### Vulnerable

```javascript
// Mass assignment — attacker can set isAdmin: true
app.post('/register', async (req, res) => {
  const user = await User.create(req.body);
  res.json(user);
});
```

### Secure

```javascript
app.post('/register', async (req, res) => {
  const { name, email, password } = req.body; // allowlist
  const user = await User.create({ name, email, password });
  res.json(user);
});
```

---

## A05 — Security Misconfiguration

### Grep patterns

```bash
# Debug / dev mode in production
grep -rnE "DEBUG\s*[:=]\s*true|NODE_ENV.*development" --include="*.{js,ts}" | grep -v node_modules

# Missing helmet
grep -rnE "require\(['\"]helmet['\"]|from ['\"]helmet['\"]" --include="*.{js,ts}"

# Verbose error details in responses
grep -rnE "res\.(json|send)\(\s*(err|error)\s*\)" --include="*.{js,ts}"

# Stack traces exposed
grep -rnE "\.stack\b" --include="*.{js,ts}" | grep -i "res\.\|response"

# X-Powered-By enabled (default in Express)
grep -rnE "disable.*x-powered-by" --include="*.{js,ts}"

# Default/example credentials
grep -rnE "(admin|password|test|1234|default)" --include="*.{js,ts}" | grep -iE "password|credential|secret"
```

### Vulnerable

```javascript
// Exposes full stack trace to client
app.use((err, req, res, next) => {
  res.status(500).json({ error: err.message, stack: err.stack });
});
```

### Secure

```javascript
const helmet = require('helmet');
app.use(helmet());
app.disable('x-powered-by');

app.use((err, req, res, next) => {
  logger.error(err); // log full detail server-side
  res.status(500).json({ error: 'Internal server error' });
});
```

---

## A06 — Vulnerable and Outdated Components

### Check methods

```bash
npm audit --json 2>/dev/null
npx npm-check-updates
grep -E "\"(version|engines)\"" package.json
```

Look for:
- Dependencies with known CVEs (from `npm audit`)
- Unpinned dependency versions (`*`, `>=`, `latest`)
- Deprecated packages
- Node.js runtime version < LTS

---

## A07 — Identification and Authentication Failures

### Grep patterns

```bash
# Weak JWT configuration
grep -rnE "expiresIn.*['\"]?\d{2,}d|algorithm.*none|algorithms.*\[.*none" --include="*.{js,ts}"

# No session expiry
grep -rnE "maxAge|expires" --include="*.{js,ts}" | grep -i "session\|cookie"

# Insecure cookie flags
grep -rnE "httpOnly:\s*false|secure:\s*false|sameSite:\s*['\"]none['\"]" --include="*.{js,ts}"

# Password stored as plaintext
grep -rnE "password\s*[:=]\s*req\.body\.password" --include="*.{js,ts}" | grep -v "hash\|bcrypt\|scrypt\|argon"
```

### Vulnerable

```javascript
// JWT with no expiry and algorithm none
const token = jwt.sign({ userId: user._id }, secret);

// Insecure session cookie
app.use(session({
  secret: 'keyboard cat',
  cookie: { secure: false, httpOnly: false },
}));
```

### Secure

```javascript
const token = jwt.sign({ userId: user._id }, secret, {
  expiresIn: '15m',
  algorithm: 'HS256',
});

app.use(session({
  secret: process.env.SESSION_SECRET,
  cookie: {
    secure: true,
    httpOnly: true,
    sameSite: 'strict',
    maxAge: 15 * 60 * 1000, // 15 min
  },
  resave: false,
  saveUninitialized: false,
}));
```

---

## A08 — Software and Data Integrity Failures

### Grep patterns

```bash
# Prototype pollution vectors
grep -rnE "Object\.assign\(.*req\.|merge\(.*req\.|_.merge\(|_.defaultsDeep\(|lodash.*merge" --include="*.{js,ts}"
grep -rnE "__proto__|constructor\[|\.prototype\s*=" --include="*.{js,ts}"

# Unsafe deserialization
grep -rnE "JSON\.parse\(.*req\.|serialize\(|unserialize\(|node-serialize" --include="*.{js,ts}"

# Missing Content Security Policy
grep -rnE "Content-Security-Policy|contentSecurityPolicy|CSP" --include="*.{js,ts}"

# Missing Subresource Integrity
grep -rnE "integrity=" --include="*.{html,ejs,pug,hbs}"
```

### Vulnerable

```javascript
// Prototype pollution via merge
const _ = require('lodash');
app.post('/config', (req, res) => {
  const config = _.merge({}, defaultConfig, req.body);
  res.json(config);
});
```

### Secure

```javascript
const config = Object.assign(
  {},
  defaultConfig,
  pick(req.body, ['theme', 'language', 'timezone']), // allowlist
);
```

---

## A09 — Security Logging and Monitoring Failures

### Grep patterns

```bash
# No logging library
grep -rnE "winston|pino|bunyan|morgan|log4js" package.json

# Sensitive data in logs
grep -rnE "console\.(log|info|warn|error).*(password|token|secret|apiKey|ssn|creditCard)" --include="*.{js,ts}"

# No request logging middleware
grep -rnE "morgan|express-winston|pino-http" --include="*.{js,ts}"
```

### Vulnerable

```javascript
// Logging sensitive data
console.log('User login:', { email, password: req.body.password });

// No structured logging
app.use((req, res, next) => next()); // no request logging
```

### Secure

```javascript
const pino = require('pino');
const logger = pino({ redact: ['req.headers.authorization', '*.password'] });

app.use(require('pino-http')({ logger }));

logger.info({ email }, 'User login attempt'); // password redacted
```

---

## A10 — Server-Side Request Forgery (SSRF)

### Grep patterns

```bash
# URL from user input passed to fetch/axios/http
grep -rnE "(axios|fetch|http\.get|https\.get|request|got)\(\s*(req\.|url|href)" --include="*.{js,ts}"
grep -rnE "new URL\(req\." --include="*.{js,ts}"

# DNS rebinding / internal network
grep -rnE "localhost|127\.0\.0\.1|0\.0\.0\.0|169\.254\.|10\.|172\.(1[6-9]|2[0-9]|3[01])\." --include="*.{js,ts}" | grep -v node_modules
```

### Vulnerable

```javascript
// SSRF — user controls the URL
app.get('/proxy', async (req, res) => {
  const response = await axios.get(req.query.url);
  res.json(response.data);
});
```

### Secure

```javascript
const { URL } = require('url');

const ALLOWED_HOSTS = ['api.example.com', 'cdn.example.com'];

app.get('/proxy', async (req, res) => {
  const parsed = new URL(req.query.url);
  if (!ALLOWED_HOSTS.includes(parsed.hostname)) {
    return res.status(403).json({ error: 'Host not allowed' });
  }
  if (parsed.protocol !== 'https:') {
    return res.status(403).json({ error: 'HTTPS required' });
  }
  const response = await axios.get(parsed.href, { timeout: 5000 });
  res.json(response.data);
});
```

---

## Additional Node.js-Specific Vulnerabilities

### ReDoS (Regular Expression Denial of Service)

```bash
grep -rnE "new RegExp\(req\.|RegExp\(.*\+.*req\." --include="*.{js,ts}"
# Check for catastrophic backtracking patterns: nested quantifiers
grep -rnE "\(.+\)\+\+|\(.+\)\*\*|\(.+\)\{.*\}\+" --include="*.{js,ts}"
```

### Event Loop Blocking

```bash
grep -rnE "readFileSync|writeFileSync|execSync|readdirSync|statSync|existsSync" --include="*.{js,ts}" | grep -v "config\|setup\|init\|bootstrap\|migration"
```

### File Upload Risks

```bash
grep -rnE "multer|formidable|busboy|multiparty" --include="*.{js,ts}"
# Check for missing file type validation
grep -rnE "mimetype|fileFilter|allowedTypes" --include="*.{js,ts}"
```

### Cross-Site Scripting (XSS)

```bash
grep -rnE "\.innerHTML\s*=|\.outerHTML\s*=|document\.write\(" --include="*.{js,ts,jsx,tsx}"
grep -rnE "dangerouslySetInnerHTML" --include="*.{jsx,tsx}"
grep -rnE "res\.(send|write)\(.*req\.(body|query|params)" --include="*.{js,ts}"
```

### HTTP Parameter Pollution

```bash
grep -rnE "hpp|http-parameter-pollution" package.json
```

---

## Node.js Runtime & Built-in Library Vulnerabilities

These are vulnerabilities in Node.js itself — the runtime, bundled OpenSSL,
HTTP parser (llhttp), V8 engine, and core built-in modules. Running an EOL
version means ALL of these are unpatched.

See `references/version-vulnerabilities.md` for the full version-to-CVE mapping.

### Runtime Version Check

```bash
# Current runtime version
node --version

# OpenSSL version bundled with this Node.js
node -e "console.log('OpenSSL:', process.versions.openssl)"

# V8 engine version
node -e "console.log('V8:', process.versions.v8)"

# Version constraints
cat .nvmrc .node-version 2>/dev/null
node -e "const p=require('./package.json'); console.log(p.engines?.node || 'NONE')" 2>/dev/null

# Docker base images
grep -rE "^FROM\s+node" Dockerfile* 2>/dev/null
```

### Built-in: Buffer constructor (memory disclosure)

```bash
# Unsafe Buffer — leaks uninitialized memory
grep -rnE "new Buffer\(|Buffer\(\s*[0-9]|Buffer\.allocUnsafe\(" --include="*.{js,ts,mjs,cjs}"
```

#### Vulnerable

```javascript
// new Buffer(n) returns uninitialized memory — may contain passwords, keys
const buf = new Buffer(100);
res.send(buf); // Sends random heap data to client

// allocUnsafe without immediate fill
const token = Buffer.allocUnsafe(32);
```

#### Secure

```javascript
// Zero-filled allocation
const buf = Buffer.alloc(100);

// From known data
const token = Buffer.from(secretString, 'utf8');

// If allocUnsafe is needed for performance, fill immediately
const fast = Buffer.allocUnsafe(32);
fast.fill(0);
```

### Built-in: child_process (command injection)

```bash
grep -rnE "require\(['\"]child_process['\"]|from ['\"]child_process['\"]" --include="*.{js,ts,mjs,cjs}"
grep -rnE "\bexec\(|\bexecSync\(" --include="*.{js,ts}" | grep -v "execFile\|RegExp"
```

#### Vulnerable

```javascript
const { exec } = require('child_process');
// User input passed to shell
exec(`convert ${req.query.filename} output.png`);
// Payload: filename=;rm -rf /
```

#### Secure

```javascript
const { execFile } = require('child_process');
// execFile does NOT use shell — arguments are passed as array
execFile('convert', [req.query.filename, 'output.png']);

// Or spawn with explicit no-shell
const { spawn } = require('child_process');
spawn('convert', [sanitizedFilename, 'output.png'], { shell: false });
```

### Built-in: vm module (sandbox escape)

```bash
grep -rnE "require\(['\"]vm['\"]|from ['\"]vm['\"]|vm\.runInNewContext|vm\.createContext|vm\.Script" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
const vm = require('vm');
// vm is NOT a security sandbox
const result = vm.runInNewContext(userCode, {});
// Escape: this.constructor.constructor('return process')().exit()
```

#### Secure

```javascript
// Use isolated-vm for actual sandboxing
const ivm = require('isolated-vm');
const isolate = new ivm.Isolate({ memoryLimit: 128 });
const context = isolate.createContextSync();

// Or worker_threads with limited transferables
const { Worker } = require('worker_threads');
```

### Built-in: inspector (debug protocol exposure)

```bash
grep -rnE "require\(['\"]inspector['\"]|require\(['\"]node:inspector['\"]|inspector\.open\(" --include="*.{js,ts}"
grep -rn "\-\-inspect" Dockerfile* docker-compose* package.json .env* 2>/dev/null
```

#### Vulnerable

```javascript
// Inspector open in production
const inspector = require('inspector');
inspector.open(9229, '0.0.0.0'); // Binds to all interfaces!

// Dockerfile with inspector exposed
// CMD ["node", "--inspect=0.0.0.0:9229", "server.js"]
```

#### Secure

```javascript
// Only in development, localhost only
if (process.env.NODE_ENV === 'development') {
  const inspector = require('inspector');
  inspector.open(9229, '127.0.0.1');
}

// Never --inspect in production Dockerfiles
// CMD ["node", "server.js"]
```

### Built-in: querystring (deprecated) and url.parse() (hostname spoofing)

```bash
grep -rnE "require\(['\"]querystring['\"]|querystring\.parse\(" --include="*.{js,ts}"
grep -rnE "url\.parse\(" --include="*.{js,ts}" | grep -v "new URL("
```

#### Vulnerable

```javascript
const url = require('url');
// url.parse() has hostname spoofing via unicode
const parsed = url.parse(userInput);
if (parsed.hostname === 'safe.example.com') {
  fetch(parsed.href); // Spoofed hostname — actually reaches attacker server
}

const qs = require('querystring');
const data = qs.parse(req.url.split('?')[1]); // Deprecated, encoding bugs
```

#### Secure

```javascript
// WHATWG URL API (correct parsing)
const parsed = new URL(userInput, 'https://base.example.com');
if (parsed.hostname === 'safe.example.com') {
  fetch(parsed.href);
}

// URLSearchParams instead of querystring
const params = new URLSearchParams(req.url.split('?')[1]);
```

### Built-in: zlib (decompression bomb)

```bash
grep -rnE "require\(['\"]zlib['\"]|zlib\.(inflate|gunzip|unzip|brotliDecompress)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
const zlib = require('zlib');
// No size limit — a 42-byte gzip can expand to petabytes
app.post('/upload', (req, res) => {
  zlib.gunzip(req.body, (err, data) => {
    processData(data); // OOM crash
  });
});
```

#### Secure

```javascript
const zlib = require('zlib');
// Limit decompressed output size
const MAX_SIZE = 10 * 1024 * 1024; // 10 MB
app.post('/upload', (req, res) => {
  if (req.headers['content-length'] > 1024 * 1024) {
    return res.status(413).send('Payload too large');
  }
  zlib.gunzip(req.body, { maxOutputLength: MAX_SIZE }, (err, data) => {
    if (err) return res.status(400).send('Invalid data');
    processData(data);
  });
});
```

### Built-in: stream.pipe() (missing error handling)

```bash
grep -rnE "\.pipe\(" --include="*.{js,ts}" | grep -v "node_modules"
```

#### Vulnerable

```javascript
// .pipe() does NOT propagate errors — unhandled error crashes process
const readStream = fs.createReadStream(filePath);
readStream.pipe(res); // If readStream errors, res hangs, process may crash
```

#### Secure

```javascript
const { pipeline } = require('stream');
// pipeline() handles errors and cleanup automatically
pipeline(
  fs.createReadStream(filePath),
  res,
  (err) => {
    if (err) {
      console.error('Stream failed:', err);
      if (!res.headersSent) res.status(500).send('Stream error');
    }
  }
);
```

### Built-in: diagnostics_channel + async_hooks (privilege escalation)

```bash
grep -rnE "require\(['\"]diagnostics_channel['\"]|require\(['\"]async_hooks['\"]" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// CVE-2025-23083: diagnostics_channel leaks worker instances
const dc = require('diagnostics_channel');
const channel = dc.channel('undici:request:create');
channel.subscribe(({ request }) => {
  // On Node.js 20-23, internal workers are exposed here
  // Attacker can grab constructor and create malicious workers
});
```

#### Secure

```javascript
// Keep Node.js ≥22.13.1 or ≥24.x
// Minimize diagnostics_channel usage in production
// Use APM tools (DataDog, NewRelic) instead of raw hooks
// For async context, prefer AsyncLocalStorage over createHook()
const { AsyncLocalStorage } = require('async_hooks');
const storage = new AsyncLocalStorage();
```

---

## Express.js Framework Vulnerabilities

### Missing helmet middleware

```bash
# Check if helmet is installed
grep -rnE "require\(['\"]helmet['\"]|from ['\"]helmet['\"]" --include="*.{js,ts}"
# Check if it's actually used as middleware
grep -rnE "app\.use\(.*helmet" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
const express = require('express');
const app = express();
// No helmet — missing 11+ security headers
app.listen(3000);
```

#### Secure

```javascript
const express = require('express');
const helmet = require('helmet');
const app = express();
app.use(helmet());
app.listen(3000);
```

### Missing CSRF protection

```bash
grep -rnE "csurf|csrf-csrf|csrf-sync|lusca.*csrf" --include="*.{js,ts}" package.json
```

#### Vulnerable

```javascript
// State-changing POST route with no CSRF token
app.post('/transfer', authenticate, async (req, res) => {
  await transferFunds(req.body.to, req.body.amount);
  res.json({ success: true });
});
```

#### Secure

```javascript
const { doubleCsrf } = require('csrf-csrf');
const { doubleCsrfProtection } = doubleCsrf({ getSecret: () => process.env.CSRF_SECRET });
app.use(doubleCsrfProtection);

app.post('/transfer', authenticate, async (req, res) => {
  await transferFunds(req.body.to, req.body.amount);
  res.json({ success: true });
});
```

### Overly permissive CORS

```bash
grep -rnE "cors\(\s*\)|cors\(\s*\{[^}]*origin\s*:\s*['\"]?\*['\"]?" --include="*.{js,ts}"
grep -rnE "cors\(\s*\{[^}]*credentials\s*:\s*true" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
const cors = require('cors');
// Allows ALL origins — any site can make authenticated requests
app.use(cors({ origin: '*', credentials: true }));
```

#### Secure

```javascript
const cors = require('cors');
app.use(cors({
  origin: ['https://app.example.com', 'https://admin.example.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
}));
```

### Body parser without size limits

```bash
grep -rnE "express\.json\(\s*\)|express\.urlencoded\(\s*\{[^}]*\}\s*\)|bodyParser\.json\(\s*\)" --include="*.{js,ts}" | grep -v "limit"
```

#### Vulnerable

```javascript
// No size limit — attacker can send 100MB+ JSON payload for DoS
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
```

#### Secure

```javascript
app.use(express.json({ limit: '100kb' }));
app.use(express.urlencoded({ extended: true, limit: '100kb' }));
```

### Static file serving with dotfiles exposed

```bash
grep -rnE "express\.static\(" --include="*.{js,ts}" | grep -v "dotfiles"
```

#### Vulnerable

```javascript
// Serves .env, .git/config, .htpasswd by default
app.use(express.static('public'));
```

#### Secure

```javascript
app.use(express.static('public', {
  dotfiles: 'deny',
  index: false,
  maxAge: '1d',
}));
```

### Trust proxy misconfiguration

```bash
grep -rnE "trust proxy.*true|set\(['\"]trust proxy['\"]" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// Trusts ALL proxies — attacker can spoof X-Forwarded-For
app.set('trust proxy', true);
```

#### Secure

```javascript
// Trust only your known reverse proxy
app.set('trust proxy', 'loopback, 10.0.0.0/8');
// Or specific proxy count
app.set('trust proxy', 1);
```

### Session misconfiguration

```bash
grep -rnE "express-session|cookie-session" --include="*.{js,ts}"
grep -rnE "secret\s*:\s*['\"][^'\"]{0,20}['\"]" --include="*.{js,ts}" | grep -i session
```

#### Vulnerable

```javascript
const session = require('express-session');
app.use(session({
  secret: 'keyboard cat',           // weak, hardcoded secret
  // No store — uses MemoryStore (leaks in production)
  cookie: { secure: false },         // sent over HTTP
}));
```

#### Secure

```javascript
const session = require('express-session');
const RedisStore = require('connect-redis').default;
app.use(session({
  store: new RedisStore({ client: redisClient }),
  secret: process.env.SESSION_SECRET,
  cookie: {
    secure: true,
    httpOnly: true,
    sameSite: 'strict',
    maxAge: 15 * 60 * 1000,
  },
  resave: false,
  saveUninitialized: false,
}));
```

### Missing error handler

```bash
# Check for 4-argument error middleware
grep -rnE "\(\s*(err|error)\s*,\s*(req|request)\s*,\s*(res|response)\s*,\s*(next)\s*\)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// No error handler — Express shows stack traces by default in dev
app.get('/users/:id', async (req, res) => {
  const user = await User.findById(req.params.id); // throws → stack trace leaked
  res.json(user);
});
```

#### Secure

```javascript
app.get('/users/:id', async (req, res, next) => {
  try {
    const user = await User.findById(req.params.id);
    if (!user) return res.status(404).json({ error: 'Not found' });
    res.json(user);
  } catch (err) { next(err); }
});

// Centralized error handler (must be last middleware)
app.use((err, req, res, next) => {
  logger.error(err);
  res.status(500).json({ error: 'Internal server error' });
});
```

### Route parameter pollution

```bash
# Express parses duplicate query params as arrays — check for type-sensitive operations
grep -rnE "req\.query\.\w+\s*===?\s*['\"]" --include="*.{js,ts}"
grep -rnE "req\.query\.\w+\.toString\(\)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// req.query.role could be "admin" OR ["admin", "user"] if sent twice
app.get('/users', (req, res) => {
  if (req.query.role === 'admin') {  // bypassed if role is an array
    return res.status(403).send('Forbidden');
  }
});
```

#### Secure

```javascript
const hpp = require('hpp');
app.use(hpp()); // takes last value for duplicate params

// Or validate explicitly
app.get('/users', (req, res) => {
  const role = Array.isArray(req.query.role) ? req.query.role[0] : req.query.role;
  if (role === 'admin') {
    return res.status(403).send('Forbidden');
  }
});
```

---

## Koa Framework Vulnerabilities

### Missing koa-helmet

```bash
grep -rnE "koa-helmet|@koa/helmet" --include="*.{js,ts}" package.json
```

#### Vulnerable

```javascript
const Koa = require('koa');
const app = new Koa();
// No security headers set
app.listen(3000);
```

#### Secure

```javascript
const Koa = require('koa');
const helmet = require('koa-helmet');
const app = new Koa();
app.use(helmet());
app.listen(3000);
```

### Mass assignment via ctx.request.body

```bash
grep -rnE "ctx\.request\.body|ctx\.body\s*=\s*ctx\." --include="*.{js,ts}"
grep -rnE "\.(create|update|findOneAndUpdate)\(\s*ctx\.request\.body" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// Attacker can set isAdmin: true in body
router.post('/users', async (ctx) => {
  const user = await User.create(ctx.request.body);
  ctx.body = user;
});
```

#### Secure

```javascript
router.post('/users', async (ctx) => {
  const { name, email, password } = ctx.request.body;
  const user = await User.create({ name, email, password });
  ctx.body = user;
});
```

### Missing CSRF protection

```bash
grep -rnE "koa-csrf|@koa/csrf|csrf" --include="*.{js,ts}" package.json
```

#### Vulnerable

```javascript
// State-changing route with no CSRF token validation
router.post('/transfer', async (ctx) => {
  await transferFunds(ctx.request.body.to, ctx.request.body.amount);
  ctx.body = { success: true };
});
```

#### Secure

```javascript
const CSRF = require('koa-csrf');
app.use(new CSRF());

router.post('/transfer', async (ctx) => {
  // CSRF token validated automatically by middleware
  await transferFunds(ctx.request.body.to, ctx.request.body.amount);
  ctx.body = { success: true };
});
```

### koa-static serving hidden files

```bash
grep -rnE "koa-static|koa-send" --include="*.{js,ts}" | grep -v "hidden\s*:\s*false"
```

#### Vulnerable

```javascript
const serve = require('koa-static');
// Default serves dotfiles (.env, .git/config)
app.use(serve('./public'));
```

#### Secure

```javascript
const serve = require('koa-static');
app.use(serve('./public', {
  hidden: false,
  index: 'index.html',
  maxage: 86400000,
}));
```

### ctx.throw leaking error internals

```bash
grep -rnE "ctx\.throw\(.*err\b|ctx\.throw\(\d+,\s*err" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
router.get('/data', async (ctx) => {
  try {
    const data = await fetchData();
    ctx.body = data;
  } catch (err) {
    ctx.throw(500, err); // leaks full error with stack trace
  }
});
```

#### Secure

```javascript
router.get('/data', async (ctx) => {
  try {
    const data = await fetchData();
    ctx.body = data;
  } catch (err) {
    logger.error(err);
    ctx.throw(500, 'Internal server error');
  }
});
```

### Missing rate limiting

```bash
grep -rnE "koa-ratelimit|koa-limit|koa-brute|ratelimit" --include="*.{js,ts}" package.json
```

#### Vulnerable

```javascript
// No rate limiting — brute force attacks possible
router.post('/login', async (ctx) => {
  const { email, password } = ctx.request.body;
  const user = await authenticate(email, password);
  ctx.body = { token: generateToken(user) };
});
```

#### Secure

```javascript
const ratelimit = require('koa-ratelimit');
app.use(ratelimit({
  driver: 'redis',
  db: redisClient,
  duration: 60000,
  max: 10,
  id: (ctx) => ctx.ip,
}));
```

### ctx.query NoSQL injection

```bash
grep -rnE "ctx\.(query|params).*\.(find|findOne|update|delete)" --include="*.{js,ts}"
grep -rnE "\.(find|findOne)\(\s*\{.*ctx\.(query|params)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// ctx.query.role could be { $ne: null } via ?role[$ne]=null
router.get('/users', async (ctx) => {
  const users = await User.find({ role: ctx.query.role });
  ctx.body = users;
});
```

#### Secure

```javascript
const { z } = require('zod');
const querySchema = z.object({ role: z.string().optional() });

router.get('/users', async (ctx) => {
  const { role } = querySchema.parse(ctx.query);
  const users = await User.find({ role });
  ctx.body = users;
});
```

---

## Webpack Security Risks

### Source maps in production

```bash
grep -rnE "devtool\s*:\s*['\"]source-map['\"]|devtool\s*:\s*['\"]eval" --include="*.{js,ts}" | grep -i "prod\|webpack\.config"
grep -rnE "SourceMapDevToolPlugin" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// webpack.config.js — exposes original source code to anyone
module.exports = {
  mode: 'production',
  devtool: 'source-map', // Generates .map files shipped to users
};
```

#### Secure

```javascript
module.exports = {
  mode: 'production',
  devtool: false, // No source maps in production
  // Or use hidden-source-map for error tracking only (not public)
  // devtool: 'hidden-source-map',
};
```

### Eval-based devtool in production

```bash
grep -rnE "devtool\s*:\s*['\"].*eval" --include="*.{js,ts}" | grep -iv "test\|dev\|development"
```

#### Vulnerable

```javascript
// eval devtools use eval() which weakens CSP and exposes source
module.exports = {
  mode: 'production',
  devtool: 'eval-source-map', // Uses eval() in bundle
};
```

#### Secure

```javascript
module.exports = (env, argv) => ({
  mode: argv.mode || 'production',
  devtool: argv.mode === 'development' ? 'eval-source-map' : false,
});
```

### DefinePlugin leaking environment variables

```bash
grep -rnE "DefinePlugin.*process\.env[^.]|DefinePlugin.*JSON\.stringify\(process\.env\)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
const webpack = require('webpack');
module.exports = {
  plugins: [
    // Serializes ALL env vars (DB passwords, API keys) into the JS bundle
    new webpack.DefinePlugin({
      'process.env': JSON.stringify(process.env),
    }),
  ],
};
```

#### Secure

```javascript
const webpack = require('webpack');
module.exports = {
  plugins: [
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),
      'process.env.API_URL': JSON.stringify(process.env.API_URL),
      // Only allowlist specific, non-secret variables
    }),
  ],
};
```

### webpack-dev-server accessible in production

```bash
grep -rnE "webpack-dev-server|devServer\s*:" --include="*.{js,ts}"
grep -rnE "webpack-dev-middleware|webpack-hot-middleware" --include="*.{js,ts}" | grep -v "NODE_ENV.*development"
```

#### Vulnerable

```javascript
// webpack-dev-server exposes source files, file system, and HMR endpoint
// If accidentally deployed or proxied in production, attackers get full source
module.exports = {
  devServer: {
    host: '0.0.0.0',  // binds to all interfaces
    port: 8080,
    hot: true,
  },
};
```

#### Secure

```javascript
// Only include devServer in development configs
// webpack.dev.js (never used in production builds)
module.exports = {
  devServer: {
    host: '127.0.0.1',  // localhost only
    port: 8080,
    hot: true,
    allowedHosts: ['localhost'],
  },
};
// Ensure production builds use webpack.prod.js without devServer
```

### publicPath exposing internal paths

```bash
grep -rnE "publicPath\s*:\s*['\"]/" --include="*.{js,ts}" | grep -v "node_modules"
```

#### Vulnerable

```javascript
module.exports = {
  output: {
    // Reveals server directory structure in asset URLs
    publicPath: '/home/deploy/app/static/',
    filename: '[name].bundle.js',
  },
};
```

#### Secure

```javascript
module.exports = {
  output: {
    publicPath: '/static/',  // relative public path only
    filename: '[name].[contenthash].bundle.js', // cache-busting
  },
};
```

---

## NestJS Framework Vulnerabilities

### Missing Guards — Routes Without AuthGuard / RolesGuard

```bash
# Controllers without @UseGuards
grep -rnl "@Controller\(" --include="*.ts" | while read f; do
  if ! grep -q "@UseGuards" "$f"; then echo "UNGUARDED: $f"; fi
done

# Global guard check
grep -rnE "APP_GUARD|useGlobalGuards" --include="*.ts"

# Sensitive routes without route-level guards
grep -rnE "@(Post|Put|Patch|Delete)\(" --include="*.ts" | grep -v "@UseGuards"
```

#### Vulnerable

```typescript
@Controller('admin')
export class AdminController {
  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.usersService.remove(id); // No auth check
  }
}
```

#### Secure

```typescript
@Controller('admin')
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('admin')
export class AdminController {
  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.usersService.remove(id);
  }
}
```

### ValidationPipe Not Applied Globally

```bash
grep -rnE "useGlobalPipes.*ValidationPipe|APP_PIPE.*ValidationPipe" --include="*.ts"
grep -rnE "new ValidationPipe\(" --include="*.ts"
```

#### Vulnerable

```typescript
// No global validation — each route must add @UsePipes manually
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);
}
```

#### Secure

```typescript
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalPipes(new ValidationPipe({
    whitelist: true,       // strip non-DTO properties
    forbidNonWhitelisted: true, // throw on unknown properties
    transform: true,
  }));
  await app.listen(3000);
}
```

### DTO Validation Bypass — class-validator Not Enforced

```bash
# DTOs without validation decorators
grep -rL "@IsString\|@IsNumber\|@IsEmail\|@IsNotEmpty" --include="*.dto.ts"
# Handlers using raw types instead of DTOs
grep -rnE "@Body\(\)\s+\w+:\s*(any|object|Record)" --include="*.ts"
```

#### Vulnerable

```typescript
export class CreateUserDto {
  name: string;     // No validation decorators
  email: string;
  role: string;     // Attacker can set role: 'admin'
}
```

#### Secure

```typescript
import { IsString, IsEmail, IsNotEmpty, IsOptional, IsIn } from 'class-validator';

export class CreateUserDto {
  @IsString() @IsNotEmpty() name: string;
  @IsEmail() email: string;
  @IsOptional() @IsIn(['user']) role?: string; // Only 'user' allowed
}
```

### CORS Misconfiguration

```bash
grep -rnE "enableCors\(\s*\)" --include="*.ts"
grep -rnE "enableCors\(\s*\{" --include="*.ts" -A 5 | grep -E "origin.*true|origin.*\*"
```

#### Vulnerable

```typescript
app.enableCors(); // Allows ALL origins with credentials
```

#### Secure

```typescript
app.enableCors({
  origin: ['https://app.example.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
});
```

### TypeORM / Prisma SQL Injection

```bash
# TypeORM raw queries with interpolation
grep -rnE "\.query\(\s*\`" --include="*.ts" | grep '\${'
grep -rnE "\.(where|andWhere|orWhere)\(\s*\`" --include="*.ts" | grep '\${'
# Prisma unsafe raw
grep -rnE "\.\$queryRawUnsafe\(|\.\$executeRawUnsafe\(" --include="*.ts"
```

#### Vulnerable

```typescript
const users = await this.userRepo.query(
  `SELECT * FROM users WHERE name = '${name}'`  // SQL injection
);

const result = await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE id = ${id}`  // SQL injection
);
```

#### Secure

```typescript
const users = await this.userRepo.query(
  'SELECT * FROM users WHERE name = $1', [name]
);

const result = await prisma.$queryRaw`
  SELECT * FROM users WHERE id = ${id}
`; // Tagged template — Prisma parameterizes this
```

### GraphQL Security — Introspection and Depth

```bash
grep -rnE "introspection\s*:\s*true" --include="*.ts"
grep -rnE "playground\s*:\s*true" --include="*.ts"
grep -rnE "depthLimit|graphql-depth-limit|graphql-query-complexity" --include="*.ts" package.json
```

#### Vulnerable

```typescript
GraphQLModule.forRoot<ApolloDriverConfig>({
  driver: ApolloDriver,
  autoSchemaFile: true,
  introspection: true,    // Schema exposed in production
  playground: true,       // Playground accessible
  // No depth limit, no complexity limit
})
```

#### Secure

```typescript
import depthLimit from 'graphql-depth-limit';

GraphQLModule.forRoot<ApolloDriverConfig>({
  driver: ApolloDriver,
  autoSchemaFile: true,
  introspection: process.env.NODE_ENV !== 'production',
  playground: false,
  validationRules: [depthLimit(7)],
})
```

### Swagger / OpenAPI Exposure in Production

```bash
grep -rnE "SwaggerModule\.setup\(" --include="*.ts"
grep -rnE "SwaggerModule" --include="*.ts" -B 5 | grep -E "NODE_ENV|production|isProd"
```

#### Vulnerable

```typescript
const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup('api/docs', app, document);
// Exposed at /api/docs in production
```

#### Secure

```typescript
if (process.env.NODE_ENV !== 'production') {
  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api/docs', app, document);
}
```

### Exception Filters Leaking Information

```bash
grep -rnE "exception\.stack|error\.stack|err\.stack" --include="*.ts" | grep -iE "response|json|send"
grep -rnE "new HttpException\(\s*err" --include="*.ts"
```

#### Vulnerable

```typescript
@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const response = host.switchToHttp().getResponse();
    response.status(500).json({
      message: exception.message,
      stack: exception.stack,  // Stack trace leaked
    });
  }
}
```

#### Secure

```typescript
@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  private readonly logger = new Logger(AllExceptionsFilter.name);

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const status = exception instanceof HttpException
      ? exception.getStatus() : HttpStatus.INTERNAL_SERVER_ERROR;

    this.logger.error(exception instanceof Error ? exception.stack : exception);
    response.status(status).json({
      statusCode: status,
      message: 'Internal server error',
    });
  }
}
```

### Serialization — Sensitive Fields Exposed

```bash
grep -rnE "password|passwordHash|secret|token|ssn" --include="*.entity.ts" | grep -v "@Exclude"
grep -rnE "ClassSerializerInterceptor|APP_INTERCEPTOR.*ClassSerializer" --include="*.ts"
```

#### Vulnerable

```typescript
@Entity()
export class User {
  @Column() email: string;
  @Column() password: string;     // Exposed in responses
  @Column() refreshToken: string; // Leaked
}
```

#### Secure

```typescript
import { Exclude } from 'class-transformer';

@Entity()
export class User {
  @Column() email: string;
  @Exclude() @Column() password: string;
  @Exclude() @Column() refreshToken: string;
}

// Register globally
@Module({
  providers: [{ provide: APP_INTERCEPTOR, useClass: ClassSerializerInterceptor }],
})
export class AppModule {}
```

### ConfigModule Without Validation

```bash
grep -rnE "process\.env\." --include="*.ts" | grep -v "node_modules\|\.config\.\|main\.ts"
grep -rnE "ConfigModule\.forRoot\(\s*\)" --include="*.ts"
```

#### Vulnerable

```typescript
@Injectable()
export class AuthService {
  private readonly jwtSecret = process.env.JWT_SECRET; // Could be undefined
}

@Module({ imports: [ConfigModule.forRoot()] }) // No validation schema
export class AppModule {}
```

#### Secure

```typescript
import * as Joi from 'joi';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      validationSchema: Joi.object({
        JWT_SECRET: Joi.string().min(32).required(),
        DATABASE_URL: Joi.string().uri().required(),
      }),
    }),
  ],
})
export class AppModule {}

@Injectable()
export class AuthService {
  constructor(private configService: ConfigService) {}
  getSecret() { return this.configService.get<string>('JWT_SECRET'); }
}
```

### WebSocket Gateway Security

```bash
grep -rnE "@WebSocketGateway\(" --include="*.ts"
grep -rnl "@WebSocketGateway" --include="*.ts" | while read f; do
  if ! grep -q "@UseGuards" "$f"; then echo "UNGUARDED_GATEWAY: $f"; fi
done
```

#### Vulnerable

```typescript
@WebSocketGateway(8080)
export class ChatGateway {
  @SubscribeMessage('message')
  handleMessage(@MessageBody() data: any): void {
    this.server.emit('message', data); // Untyped, unvalidated, unauthenticated
  }
}
```

#### Secure

```typescript
@WebSocketGateway(8080, {
  cors: { origin: ['https://app.example.com'], credentials: true },
})
@UseGuards(WsJwtAuthGuard)
@UsePipes(new ValidationPipe({ whitelist: true, transform: true }))
export class ChatGateway implements OnGatewayConnection {
  async handleConnection(client: Socket) {
    const token = client.handshake.auth?.token;
    if (!token) { client.disconnect(); return; }
    client.data.user = await this.authService.verifyToken(token);
  }

  @SubscribeMessage('message')
  handleMessage(@ConnectedSocket() client: Socket, @MessageBody() data: ChatMessageDto) {
    this.server.to(data.room).emit('message', { from: client.data.user.id, content: data.content });
  }
}
```

### File Upload Without Validation

```bash
grep -rnE "@UploadedFile\(\)" --include="*.ts" | grep -v "ParseFilePipe\|FileValidator"
grep -rnE "FileInterceptor\(" --include="*.ts" | grep -v "limits\|fileFilter"
```

#### Vulnerable

```typescript
@Post()
@UseInterceptors(FileInterceptor('file'))
uploadFile(@UploadedFile() file: Express.Multer.File) {
  return { filename: file.originalname }; // Accepts ANY file
}
```

#### Secure

```typescript
@Post()
@UseInterceptors(FileInterceptor('file', {
  limits: { fileSize: 5 * 1024 * 1024, files: 1 },
  fileFilter: (req, file, cb) => {
    if (!file.mimetype.match(/^image\/(jpeg|png|gif|webp)$/)) {
      return cb(new BadRequestException('Only images'), false);
    }
    cb(null, true);
  },
}))
uploadFile(@UploadedFile(new ParseFilePipe({
  validators: [
    new MaxFileSizeValidator({ maxSize: 5 * 1024 * 1024 }),
    new FileTypeValidator({ fileType: /^image\/(jpeg|png|gif|webp)$/ }),
  ],
})) file: Express.Multer.File) {
  const safeName = file.originalname.replace(/[^a-zA-Z0-9._-]/g, '_');
  return { filename: safeName };
}
```

---

## Fastify Framework Vulnerabilities

### Schema Validation Bypass

```bash
# Routes without schema
grep -rnE "fastify\.(get|post|put|patch|delete)\s*\(" --include="*.{js,ts,mjs}" | grep -v "schema"
# Routes with schema but additionalProperties not false
grep -rnE "schema\s*:" --include="*.{js,ts,mjs}" -A 10 | grep -v "additionalProperties"
```

#### Vulnerable

```javascript
fastify.post('/api/users', async (request, reply) => {
  return User.create(request.body); // No validation, mass assignment
});
```

#### Secure

```javascript
fastify.post('/api/users', {
  schema: {
    body: {
      type: 'object',
      required: ['name', 'email', 'password'],
      additionalProperties: false,
      properties: {
        name: { type: 'string', minLength: 1, maxLength: 100 },
        email: { type: 'string', format: 'email' },
        password: { type: 'string', minLength: 8 },
      },
    },
  },
}, async (request, reply) => {
  return User.create(request.body);
});
```

### Missing @fastify/helmet

```bash
grep -rnE "@fastify/helmet|fastify-helmet" --include="*.{js,ts,mjs}" package.json
```

#### Vulnerable

```javascript
const fastify = require('fastify')({ logger: true });
// No security headers
fastify.listen({ port: 3000 });
```

#### Secure

```javascript
const fastify = require('fastify')({ logger: true });
await fastify.register(require('@fastify/helmet'), {
  contentSecurityPolicy: { directives: { defaultSrc: ["'self'"] } },
});
```

### @fastify/cors Misconfiguration

```bash
grep -rnE "@fastify/cors|fastify-cors" --include="*.{js,ts,mjs}" -A 10
grep -rnE "origin\s*:\s*true|origin\s*:\s*['\"]?\*" --include="*.{js,ts,mjs}"
```

#### Vulnerable

```javascript
fastify.register(require('@fastify/cors'), {
  origin: true,        // Reflects any origin
  credentials: true,   // Cookies sent to any origin
});
```

#### Secure

```javascript
fastify.register(require('@fastify/cors'), {
  origin: ['https://app.example.com'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE'],
  strictPreflight: true,
});
```

### Trust Proxy Misconfiguration

```bash
grep -rnE "trustProxy\s*:\s*true" --include="*.{js,ts,mjs}"
```

#### Vulnerable

```javascript
const fastify = require('fastify')({ trustProxy: true }); // Trusts all proxies
```

#### Secure

```javascript
const fastify = require('fastify')({
  trustProxy: '10.0.0.0/8, 172.16.0.0/12', // Only known proxies
});
```

### Plugin Encapsulation Bypass

```bash
grep -rnE "fastify-plugin|fp\(" --include="*.{js,ts,mjs}"
grep -rnE "fastify\.decorate\(" --include="*.{js,ts,mjs}"
```

#### Vulnerable

```javascript
const fp = require('fastify-plugin');
// fp() breaks encapsulation — adminSecret accessible to ALL plugins
const dbPlugin = fp(async function (fastify, opts) {
  fastify.decorate('adminSecret', opts.adminSecret);
});
```

#### Secure

```javascript
// Do NOT wrap with fp — let encapsulation protect sensitive decorators
const adminPlugin = async function (fastify, opts) {
  fastify.decorate('adminSecret', opts.adminSecret);
  // Only accessible within this plugin's scope
};
```

### Content Type Parser Without Size Limits

```bash
grep -rnE "addContentTypeParser\(" --include="*.{js,ts,mjs}" -A 5 | grep -v "bodyLimit\|parseAs"
```

#### Vulnerable

```javascript
fastify.addContentTypeParser('application/xml', function (req, body, done) {
  let data = '';
  req.on('data', (chunk) => { data += chunk; }); // Unbounded memory growth
  req.on('end', () => { done(null, parseXml(data)); });
});
```

#### Secure

```javascript
fastify.addContentTypeParser(
  'application/xml',
  { parseAs: 'string', bodyLimit: 1024 * 1024 }, // 1MB limit
  function (req, body, done) {
    try { done(null, parseXml(body)); }
    catch (err) { err.statusCode = 400; done(err); }
  }
);
```

### @fastify/static Directory Traversal

```bash
grep -rnE "@fastify/static|fastify-static" --include="*.{js,ts,mjs}" -A 15
grep -rnE "root\s*:" --include="*.{js,ts,mjs}" | grep -v "node_modules"
```

#### Vulnerable

```javascript
fastify.register(require('@fastify/static'), {
  root: path.join(__dirname), // Serves project root including .env
  prefix: '/',
});
```

#### Secure

```javascript
fastify.register(require('@fastify/static'), {
  root: path.join(__dirname, 'public'),
  prefix: '/static/',
  list: false,
  index: false,
  allowedPath: (pathName) => !pathName.includes('/.') && !pathName.startsWith('.'),
});
```

### reply.hijack() Misuse

```bash
grep -rnE "reply\.hijack\(\)" --include="*.{js,ts,mjs}"
grep -rnE "reply\.raw\.(write|end|writeHead)" --include="*.{js,ts,mjs}"
```

#### Vulnerable

```javascript
fastify.get('/stream', async (request, reply) => {
  reply.hijack();
  const stream = getDataStream();
  stream.pipe(reply.raw); // No error handling, no security headers
});
```

#### Secure

```javascript
// Prefer Fastify's built-in stream support
fastify.get('/stream', async (request, reply) => {
  const stream = getDataStream();
  reply.type('application/octet-stream');
  return reply.send(stream); // Fastify handles errors and cleanup
});
```

### Route-Level Hooks Missing on Sensitive Routes

```bash
grep -rnE "fastify\.(post|put|patch|delete)\s*\(" --include="*.{js,ts,mjs}" | grep -v "preHandler\|preValidation\|onRequest\|authenticate"
```

#### Vulnerable

```javascript
fastify.delete('/admin/users/:id', async (request, reply) => {
  await User.deleteById(request.params.id); // No auth check
  return { deleted: true };
});
```

#### Secure

```javascript
fastify.register(async function adminRoutes(fastify) {
  fastify.addHook('onRequest', fastify.authenticate);
  fastify.addHook('onRequest', fastify.requireAdmin);

  fastify.delete('/admin/users/:id', async (request, reply) => {
    await User.deleteById(request.params.id);
    return { deleted: true };
  });
}, { prefix: '/admin' });
```

### TypeBox/JSON Schema Injection

```bash
# Dynamic schema construction with user input
grep -rnE "schema\s*=.*req\.|schema\s*=.*request\." --include="*.{js,ts,mjs}"
grep -rnE "Type\.\w+\(.*req\." --include="*.{js,ts,mjs}"
grep -rnE "JSON\.parse\(.*schema|schema.*JSON\.parse\(" --include="*.{js,ts,mjs}"
```

#### Vulnerable

```javascript
// User input used to construct schema — enables RCE via new Function()
fastify.post('/api/dynamic-form', async (request, reply) => {
  const { fields } = request.body;
  const schema = { body: { type: 'object', properties: {} } };
  for (const field of fields) {
    schema.body.properties[field.name] = { type: field.type }; // Attacker-controlled
  }
});
```

#### Secure

```javascript
// Pre-define all schemas at startup — NEVER at request time
const FORM_SCHEMAS = {
  contact: { body: Type.Object({
    name: Type.String({ minLength: 1, maxLength: 100 }),
    email: Type.String({ format: 'email' }),
  })},
};

fastify.post('/api/submit/:formType', {
  schema: { params: { type: 'object', properties: {
    formType: { type: 'string', enum: Object.keys(FORM_SCHEMAS) },
  }}},
}, async (request, reply) => {
  const schema = FORM_SCHEMAS[request.params.formType];
  if (!schema) return reply.code(400).send({ error: 'Unknown form' });
  return processForm(request.params.formType, request.body);
});
```

### WebSocket Security — @fastify/websocket Without Auth

```bash
grep -rnE "websocket\s*:\s*true" --include="*.{js,ts,mjs}" -B 5 -A 10 | grep -v "preValidation\|onRequest\|authenticate"
```

#### Vulnerable

```javascript
fastify.get('/ws/messages', { websocket: true }, (socket, request) => {
  messageStream.on('newMessage', (msg) => {
    socket.send(JSON.stringify(msg)); // Private data to unauthorized client
  });
});
```

#### Secure

```javascript
fastify.get('/ws/messages', {
  websocket: true,
  preValidation: async (request, reply) => {
    const token = request.headers.authorization?.replace('Bearer ', '') || request.query.token;
    if (!token) return reply.code(401).send({ error: 'Unauthorized' });
    request.user = await verifyJWT(token);
  },
}, (socket, request) => {
  const userId = request.user.id;
  messageStream.on('newMessage', (msg) => {
    if (msg.recipientId === userId) socket.send(JSON.stringify(msg));
  });
});
```

---

## Bun Runtime Vulnerabilities

### Bun.serve() — Missing Security Headers and TLS

```bash
grep -rnE "Bun\.serve\s*\(" --include="*.{js,ts,mjs,mts}"
grep -rnE "Bun\.serve\s*\(" --include="*.{js,ts,mjs,mts}" | grep -v "hostname"
grep -rnE "Content-Security-Policy|X-Content-Type-Options|Strict-Transport-Security" --include="*.{js,ts,mjs,mts}"
```

#### Vulnerable

```javascript
Bun.serve({
  port: 3000,
  // No hostname — binds to 0.0.0.0, no TLS, no security headers
  async fetch(req) {
    const body = await req.json(); // No size limit
    return Response.json({ ok: true });
  },
});
```

#### Secure

```javascript
Bun.serve({
  port: 3000,
  hostname: "127.0.0.1",
  idleTimeout: 10,
  tls: { cert: Bun.file("./cert.pem"), key: Bun.file("./key.pem") },
  async fetch(req) {
    const contentLength = parseInt(req.headers.get("content-length") || "0");
    if (contentLength > 1_048_576) return new Response("Too Large", { status: 413 });
    const body = await req.json();
    return new Response(JSON.stringify({ ok: true }), {
      headers: {
        "Content-Type": "application/json",
        "Content-Security-Policy": "default-src 'self'",
        "X-Content-Type-Options": "nosniff",
        "X-Frame-Options": "DENY",
        "Strict-Transport-Security": "max-age=31536000; includeSubDomains",
      },
    });
  },
});
```

### Bun Shell — Command Injection

```bash
grep -rnE "import\s*\{[^}]*\$[^}]*\}\s*from\s*['\"]bun['\"]" --include="*.{js,ts,mjs,mts}"
grep -rnE "await\s+\$\`" --include="*.{js,ts,mjs,mts}"
grep -rnE "\{\s*raw\s*:" --include="*.{js,ts,mjs,mts}"
grep -rnE "\$\`.*bash\s+-c|\$\`.*sh\s+-c" --include="*.{js,ts,mjs,mts}"
```

#### Vulnerable

```javascript
import { $ } from "bun";
// Raw escape hatch bypasses all escaping
await $`echo ${{ raw: userInput }}`;

// Shell-within-shell bypasses Bun's escaping
await $`bash -c "echo Hello ${userInput}"`;

// Argument injection — git interprets attacker-controlled flags
await $`git ls-remote origin ${branch}`; // branch = "--upload-pack=echo pwned"
```

#### Secure

```javascript
import { $ } from "bun";
// SAFE: Interpolated variables are escaped by default
await $`ls ${userInput}`;

// Validate before use
if (!/^[a-zA-Z0-9._\-\/]+$/.test(branch)) throw new Error("Invalid branch");
await $`git checkout -- ${filename}`; // Use -- to separate options from arguments
```

### bun:sqlite — SQL Injection

```bash
grep -rnE "from ['\"]bun:sqlite['\"]" --include="*.{js,ts,mjs,mts}"
grep -rnE "db\.(query|prepare|run|exec)\s*\(\s*\`" --include="*.{js,ts,mjs,mts}" | grep '\${'
grep -rnE "new\s+Database\s*\(" --include="*.{js,ts,mjs,mts}" | grep -v "strict"
```

#### Vulnerable

```javascript
import { Database } from "bun:sqlite";
const db = new Database("app.db"); // No strict mode
const user = db.query(`SELECT * FROM users WHERE id = ${userId}`).get(); // SQL injection
```

#### Secure

```javascript
import { Database } from "bun:sqlite";
const db = new Database("app.db", { strict: true });
const user = db.query("SELECT * FROM users WHERE id = ?1").get(userId);
```

### Bun.file() / Bun.write() — Path Traversal

```bash
grep -rnE "Bun\.file\s*\(.*req\.|Bun\.file\s*\(.*params\." --include="*.{js,ts,mjs,mts}"
grep -rnE "Bun\.write\s*\(.*req\." --include="*.{js,ts,mjs,mts}"
grep -rnE "Bun\.file\s*\(\s*\`" --include="*.{js,ts,mjs,mts}"
```

#### Vulnerable

```javascript
Bun.serve({
  routes: {
    "/files/:name": (req) => {
      return new Response(Bun.file(`./uploads/${req.params.name}`));
      // attacker sends: ../../../etc/passwd
    },
  },
});
```

#### Secure

```javascript
import { resolve } from "path";
const UPLOADS_DIR = resolve("./uploads");

Bun.serve({
  routes: {
    "/files/:name": (req) => {
      const filename = req.params.name;
      if (filename.includes("..") || filename.includes("/")) {
        return new Response("Forbidden", { status: 403 });
      }
      const fullPath = resolve(UPLOADS_DIR, filename);
      if (!fullPath.startsWith(UPLOADS_DIR)) {
        return new Response("Forbidden", { status: 403 });
      }
      return new Response(Bun.file(fullPath));
    },
  },
});
```

### Non-Cryptographic Bun.hash Used for Security

```bash
grep -rnE "Bun\.hash\b|Bun\.hash\.(wyhash|crc32|adler32|cityHash|xxHash|murmur)" --include="*.{js,ts,mjs,mts}"
grep -rnE "CryptoHasher\s*\(\s*['\"]md[45]['\"]|CryptoHasher\s*\(\s*['\"]sha1['\"]" --include="*.{js,ts,mjs,mts}"
```

#### Vulnerable

```javascript
const token = Bun.hash("session-" + userId).toString(16); // wyhash — NOT crypto
const checksum = Bun.hash.crc32(fileContents); // NOT for integrity verification
```

#### Secure

```javascript
const hash = await Bun.password.hash(password, { algorithm: "argon2id", memoryCost: 65536, timeCost: 3 });
const isValid = await Bun.password.verify(inputPassword, storedHash);
const sessionToken = crypto.randomUUID();

const hasher = new Bun.CryptoHasher("sha256");
hasher.update(data);
const digest = hasher.digest("hex");
```

### Bun Prototype Pollution (CVE-2024-21548)

```bash
# Check Bun version < 1.1.30
bun --version 2>/dev/null
grep -rnE "\"bun\":" package.json 2>/dev/null
```

Bun versions < 1.1.30 are vulnerable to CVE-2024-21548 (CVSS 7.5 High) — application-level prototype pollution through Bun's runtime native API for global objects.

**Remediation:** Upgrade to Bun >= 1.1.30.

---

## AWS Lambda (Node.js) Vulnerabilities

### Event Source Injection

```bash
grep -rnE "event\.(body|queryStringParameters|pathParameters|headers)" --include="*.{js,ts}" | grep -iE "query\|exec\|find\|eval\|db\."
grep -rnE "JSON\.parse\(event\.body\)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
exports.handler = async (event) => {
  const body = JSON.parse(event.body);
  const result = await db.query(`SELECT * FROM users WHERE name = '${body.name}'`); // SQL injection
  return { statusCode: 200, body: JSON.stringify(result) };
};
```

#### Secure

```javascript
import { z } from 'zod';
const schema = z.object({ name: z.string().min(1).max(100) });

exports.handler = async (event) => {
  const body = schema.parse(JSON.parse(event.body));
  const result = await db.query('SELECT * FROM users WHERE name = $1', [body.name]);
  return { statusCode: 200, body: JSON.stringify(result) };
};
```

### Environment Variable Secrets Exposure

```bash
grep -rnEi "(PASSWORD|SECRET|API_KEY|TOKEN|DATABASE_URL)\s*[:=]\s*['\"][^'\"]{4,}" --include="*.{js,ts}" | grep -v node_modules
grep -rnE "process\.env\.(DB_PASSWORD|SECRET|API_KEY|JWT_SECRET)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// Secrets in plaintext env vars — visible in AWS Console, CloudFormation, CLI
const JWT_SECRET = process.env.JWT_SECRET || 'fallback-secret-123';
```

#### Secure

```javascript
import { SecretsManagerClient, GetSecretValueCommand } from '@aws-sdk/client-secrets-manager';
const client = new SecretsManagerClient({});
const secret = await client.send(new GetSecretValueCommand({ SecretId: 'my-app/jwt-secret' }));
const JWT_SECRET = JSON.parse(secret.SecretString).jwtSecret;
```

### IAM Over-Permission

```bash
grep -rnE '"Action"\s*:\s*"\*"|"Resource"\s*:\s*"\*"' --include="*.{json,yml,yaml,tf}" .
grep -rnE "Effect.*Allow.*Action.*\*" --include="*.{json,yml,yaml}" .
```

#### Vulnerable

```yaml
# serverless.yml
provider:
  iam:
    role:
      statements:
        - Effect: Allow
          Action: '*'           # Full AWS access
          Resource: '*'
```

#### Secure

```yaml
provider:
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:Query
          Resource: !GetAtt UsersTable.Arn
```

### Function URL Without Authentication

```bash
grep -rnE "AuthType.*NONE|authorization_type.*NONE|auth_type.*none" --include="*.{json,yml,yaml,tf}" .
grep -rnE "FunctionUrlConfig" --include="*.{json,yml,yaml}" .
```

#### Vulnerable

```yaml
# SAM template
MyFunction:
  Type: AWS::Lambda::Url
  Properties:
    AuthType: NONE  # Anyone on the internet can invoke
```

#### Secure

```yaml
MyFunction:
  Type: AWS::Lambda::Url
  Properties:
    AuthType: AWS_IAM  # Requires signed requests
```

### /tmp Directory Abuse

```bash
grep -rnE "/tmp/" --include="*.{js,ts}" | grep -v node_modules
grep -rnE "writeFileSync.*\/tmp|writeFile.*\/tmp" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
// Secrets written to /tmp persist across warm invocations
const fs = require('fs');
fs.writeFileSync('/tmp/db-credentials.json', JSON.stringify(creds));
// Next invocation reads stale or another tenant's credentials
```

#### Secure

```javascript
// Use in-memory only, never persist secrets to /tmp
const creds = await getSecretsFromSSM();
// If /tmp is needed for temp files, clean up after use
try {
  fs.writeFileSync('/tmp/processing.tmp', data);
  await process('/tmp/processing.tmp');
} finally {
  fs.unlinkSync('/tmp/processing.tmp');
}
```

### Sensitive Data in CloudWatch Logs

```bash
grep -rnE "console\.log\(.*event\)|console\.log\(JSON\.stringify\(event\)\)" --include="*.{js,ts}"
grep -rnE "console\.(log|info|error).*(password|token|secret|authorization)" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
exports.handler = async (event) => {
  console.log('Received event:', JSON.stringify(event)); // Logs auth tokens, cookies
  console.log('Token:', event.headers.Authorization);     // Logs JWT
};
```

#### Secure

```javascript
const pino = require('pino');
const logger = pino({ redact: ['event.headers.Authorization', '*.password', '*.token'] });

exports.handler = async (event) => {
  logger.info({ path: event.path, method: event.httpMethod }, 'Request received');
};
```

### Lambda Layer Poisoning

```bash
# Check for layers from external/untrusted accounts
grep -rnE "arn:aws:lambda:[^:]+:[0-9]+:layer:" --include="*.{json,yml,yaml,tf}" . | grep -v "$(aws sts get-caller-identity --query Account --output text 2>/dev/null)"
```

Untrusted Lambda layers can inject malicious code that runs in your function's execution environment. Only use layers from your own account or verified AWS partners.

---

## Docker / ECS / Fargate Deployment Vulnerabilities

### Dockerfile Running as Root

```bash
grep -rL "^USER" Dockerfile* 2>/dev/null
grep -rnE "^USER\s+(root|0)" Dockerfile* 2>/dev/null
```

#### Vulnerable

```dockerfile
FROM node:22-slim
WORKDIR /app
COPY . .
RUN npm ci
CMD ["node", "server.js"]
# Runs as root — container escape = host root access
```

#### Secure

```dockerfile
FROM node:22-slim
WORKDIR /app
COPY package*.json ./
RUN npm ci --omit=dev
COPY --chown=node:node . .
USER node
CMD ["node", "server.js"]
```

### Debug --inspect Flag in Production

```bash
grep -rnE "\-\-inspect|\-\-inspect-brk" Dockerfile* docker-compose*.yml package.json 2>/dev/null
```

#### Vulnerable

```dockerfile
CMD ["node", "--inspect=0.0.0.0:9229", "server.js"]
# Debug port exposed — allows remote code execution
```

#### Secure

```dockerfile
CMD ["node", "server.js"]
# Never use --inspect in production
```

### Secrets in Dockerfile

```bash
grep -rnEi "^(ARG|ENV)\s+(PASSWORD|SECRET|API_KEY|TOKEN|PRIVATE_KEY|DB_PASS|AWS_ACCESS|AWS_SECRET|DATABASE_URL)" Dockerfile* 2>/dev/null
grep -rnE "^COPY\s+.*\.(env|pem|key)" Dockerfile* 2>/dev/null
```

#### Vulnerable

```dockerfile
ARG DB_PASSWORD=supersecret123
ENV JWT_SECRET=my-jwt-secret
COPY .env .
```

#### Secure

```dockerfile
# Use runtime env vars or secrets management
# ECS: use secrets from Parameter Store or Secrets Manager
# docker-compose: use docker secrets
# Never bake secrets into the image
```

### Missing .dockerignore

```bash
test -f .dockerignore || echo "MISSING"
for p in node_modules .env .git; do
  grep -q "$p" .dockerignore 2>/dev/null || echo "NOT EXCLUDED: $p"
done
```

Without `.dockerignore`, `COPY . .` includes `node_modules/`, `.env`, `.git/`, test files, and other sensitive content in the image.

### npm install Instead of npm ci

```bash
grep -rnE "RUN\s+npm\s+install" Dockerfile* 2>/dev/null
```

#### Vulnerable

```dockerfile
COPY package.json ./
RUN npm install  # Non-deterministic, includes devDependencies
```

#### Secure

```dockerfile
COPY package.json package-lock.json ./
RUN npm ci --omit=dev && npm cache clean --force
```

### Missing SIGTERM Handler

```bash
grep -rnE "process\.on\(\s*['\"]SIG(TERM|INT)" --include="*.{js,ts}"
grep -rnE "server\.close|gracefulShutdown" --include="*.{js,ts}"
```

#### Vulnerable

```javascript
app.listen(3000);
// SIGTERM ignored → 30s wait → SIGKILL → dropped requests
```

#### Secure

```javascript
const server = app.listen(3000);

async function gracefulShutdown(signal) {
  console.log(`${signal} received. Shutting down...`);
  server.close(() => console.log('HTTP server closed'));
  await db.end();
  setTimeout(() => process.exit(0), 10_000);
}

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
```

### ECS Task Definition Risks

```bash
grep -rnE '"privileged"\s*:\s*true|"networkMode"\s*:\s*"host"' --include="*.{json,tf}" .
grep -rnE '"name"\s*:\s*"(PASSWORD|SECRET|API_KEY|TOKEN|DATABASE_URL)"' --include="*.json" . | grep '"value"'
```

#### Vulnerable

```json
{
  "containerDefinitions": [{
    "privileged": true,
    "environment": [
      { "name": "DB_PASSWORD", "value": "supersecret123" }
    ]
  }]
}
```

#### Secure

```json
{
  "containerDefinitions": [{
    "privileged": false,
    "secrets": [
      { "name": "DB_PASSWORD", "valueFrom": "arn:aws:ssm:us-east-1:123:parameter/db-password" }
    ],
    "linuxParameters": { "initProcessEnabled": true }
  }]
}
```

### ALB Without WAF and TLS

```bash
grep -rnE "aws_lb\b|LoadBalancer" --include="*.{tf,json}" .
grep -rL "waf\|web_acl\|WebACL" --include="*.tf" . 2>/dev/null
grep -rnE '"Protocol"\s*:\s*"HTTP"' --include="*.{json,tf}" . | grep -i "listener"
```

#### Vulnerable

```hcl
resource "aws_lb_listener" "http" {
  load_balancer_arn = aws_lb.app.arn
  port              = 80
  protocol          = "HTTP"  # No TLS, no WAF
  default_action { type = "forward"; target_group_arn = aws_lb_target_group.app.arn }
}
```

#### Secure

```hcl
resource "aws_lb_listener" "http" {
  port     = 80
  protocol = "HTTP"
  default_action {
    type = "redirect"
    redirect { port = "443"; protocol = "HTTPS"; status_code = "HTTP_301" }
  }
}

resource "aws_lb_listener" "https" {
  port            = 443
  protocol        = "HTTPS"
  ssl_policy      = "ELBSecurityPolicy-TLS13-1-2-2021-06"
  certificate_arn = aws_acm_certificate.app.arn
  default_action { type = "forward"; target_group_arn = aws_lb_target_group.app.arn }
}

resource "aws_wafv2_web_acl_association" "app" {
  resource_arn = aws_lb.app.arn
  web_acl_arn  = aws_wafv2_web_acl.app.arn
}
```

### No Image Vulnerability Scanning

```bash
grep -rnE "scan_on_push|trivy|snyk container|grype|hadolint" --include="*.{tf,yml,yaml}" . .github/workflows/*.yml 2>/dev/null
```

Without automated scanning, known CVEs in base images and dependencies ship to production undetected. Use ECR scan-on-push, Trivy, or Snyk in CI/CD.

---

## AWS AppSync & Amplify Gen 2 Vulnerabilities

### API Key Exposure

```bash
grep -rnE "da2-[a-z0-9]{26}" --include="*.{js,ts,jsx,tsx}" | grep -v node_modules
grep -rnE "x-api-key" --include="*.{js,ts,jsx,tsx}" | grep -v node_modules
grep -rnE "apiKey.*da2-|API_KEY.*da2-" --include="*.{env,env.*}"
```

#### Vulnerable

```javascript
const client = new AppSyncClient({
  url: 'https://xxx.appsync-api.region.amazonaws.com/graphql',
  apiKey: 'da2-abcdefghijklmnopqrstuvwxyz', // Hardcoded API key
});
```

#### Secure

```javascript
const client = new AppSyncClient({
  url: process.env.APPSYNC_URL,
  auth: { type: 'AMAZON_COGNITO_USER_POOLS', jwtToken: async () => getToken() },
});
// Use Cognito or IAM auth instead of API keys for production
```

### Authorization Mode Misconfiguration

```bash
grep -rnE "@auth\(" --include="*.graphql" | grep -v "rules"
grep -rnl "^type\s" --include="*.graphql" | while read f; do
  grep "^type " "$f" | grep -v "@auth\|@aws_" && echo "NO_AUTH: $f"
done
grep -rnE "authorizationConfig|defaultAuthorization" --include="*.{ts,js}" | grep -i "API_KEY"
```

#### Vulnerable

```graphql
# No @auth directive — accessible to anyone with API key
type User @model {
  id: ID!
  email: String!
  ssn: String        # Sensitive field, no protection
  creditScore: Int   # Financial data, no protection
}
```

#### Secure

```graphql
type User @model @auth(rules: [
  { allow: owner },
  { allow: groups, groups: ["admin"], operations: [read, update, delete] }
]) {
  id: ID!
  email: String!
  ssn: String @auth(rules: [{ allow: owner }, { allow: groups, groups: ["admin"] }])
  creditScore: Int @auth(rules: [{ allow: owner }])
}
```

### GraphQL Introspection in Production

```bash
grep -rnE "introspection" --include="*.{ts,js,json,yml}" | grep -iv "false\|disable"
```

GraphQL introspection reveals the full API schema including types, queries, mutations, and subscriptions. Disable in production to prevent attackers from mapping your API surface.

### Resolver Injection

```bash
# VTL resolvers with unsanitized input
grep -rnE "\$util\.toJson\(\$context\.arguments\)" --include="*.vtl"
grep -rnE "\$ctx\.args" --include="*.vtl" | grep -v "util\."
# JS resolvers with template literals
grep -rnE "\`.*\$\{ctx\." --include="*.{js,ts}" | grep -iE "query\|select\|insert\|update"
```

#### Vulnerable

```javascript
// AppSync JS resolver — SQL injection via ctx.arguments
export function request(ctx) {
  return {
    operation: 'Invoke',
    payload: {
      sql: `SELECT * FROM users WHERE name = '${ctx.arguments.name}'`, // Injection
    },
  };
}
```

#### Secure

```javascript
export function request(ctx) {
  return {
    operation: 'Invoke',
    payload: {
      sql: 'SELECT * FROM users WHERE name = :name',
      parameters: [{ name: 'name', value: ctx.arguments.name }],
    },
  };
}
```

### Cognito Misconfiguration

```bash
grep -rnE "selfSignUpEnabled\s*:\s*true" --include="*.{ts,js,json}"
grep -rnE "passwordPolicy" --include="*.{ts,js,json}" -A 5
grep -rnE "allowUnauthenticatedIdentities\s*:\s*true" --include="*.{ts,js,json}"
```

#### Vulnerable

```typescript
const userPool = new cognito.UserPool(this, 'Pool', {
  selfSignUpEnabled: true,
  passwordPolicy: { minLength: 6 }, // Weak password
  // No MFA, no email verification required
});
```

#### Secure

```typescript
const userPool = new cognito.UserPool(this, 'Pool', {
  selfSignUpEnabled: true,
  passwordPolicy: { minLength: 12, requireLowercase: true, requireUppercase: true, requireDigits: true, requireSymbols: true },
  mfa: cognito.Mfa.REQUIRED,
  mfaSecondFactor: { sms: true, otp: true },
  signInAliases: { email: true },
  autoVerify: { email: true },
  accountRecovery: cognito.AccountRecovery.EMAIL_ONLY,
});
```

### AppSync Events (WebSocket) Security

```bash
grep -rnE "AppSyncEventsApi|EventApi|ChannelNamespace" --include="*.{ts,js,json}"
grep -rnE "publishHandlers|subscribeHandlers" --include="*.{ts,js}" | grep -v "auth"
```

AppSync Events provides real-time WebSocket pub/sub. Ensure channel namespaces have proper authorization configured, and that publish/subscribe handlers validate permissions.

### CDK/Amplify Output Secrets

```bash
grep -rnE "CfnOutput|new\s+cdk\.CfnOutput" --include="*.{ts,js}" | grep -iE "secret\|key\|password\|token"
grep -rnE "amplify_outputs" --include="*.{ts,js,json}" | grep -iE "apiKey\|secret"
```

#### Vulnerable

```typescript
new cdk.CfnOutput(this, 'ApiKey', { value: api.apiKey }); // API key in CloudFormation outputs
new cdk.CfnOutput(this, 'DbPassword', { value: dbPassword }); // Secret in stack outputs
```

#### Secure

```typescript
// Store secrets in Secrets Manager, reference by ARN only
new cdk.CfnOutput(this, 'ApiEndpoint', { value: api.graphqlUrl }); // Only non-sensitive values
// Use ssm.StringParameter or secretsmanager.Secret for sensitive values
```

### Query Depth and Complexity Attacks

Without depth and complexity limits, attackers can craft deeply nested or expensive GraphQL queries that consume excessive server resources. For AppSync, configure max depth in the API settings. For self-hosted Apollo with NestJS, use `graphql-depth-limit` and `graphql-query-complexity`.

```bash
# Check for depth/complexity limits
grep -rnE "maxDepth|depthLimit|graphql-depth-limit|graphql-query-complexity" --include="*.{ts,js,json}" package.json
```

---

## Terraform IaC Vulnerabilities (Lambda/ECS Node.js)

Scan `*.tf` files for infrastructure misconfigurations that affect Lambda and ECS/Fargate Node.js deployments. These patterns complement the application-level checks above with infrastructure-level security.

**Detection:** `find . -name "*.tf" -not -path "*/node_modules/*" -not -path "*/.terraform/*" 2>/dev/null`

### TF-LAMBDA-001: IAM Wildcard Actions

```bash
rg 'actions\s*=\s*\[\s*"\*"\s*\]' --type tf
rg '"Action"\s*:\s*"\*"' --type tf
rg '"(s3|dynamodb|lambda|iam|ec2|sqs|sns|kms|logs|sts|secretsmanager|ssm|ecs|ecr):\*"' --type tf
```

#### Vulnerable

```hcl
resource "aws_iam_role_policy" "lambda" {
  policy = jsonencode({
    Statement = [{
      Effect   = "Allow"
      Action   = "*"
      Resource = "*"
    }]
  })
}
```

#### Secure

```hcl
resource "aws_iam_role_policy" "lambda" {
  policy = jsonencode({
    Statement = [{
      Effect   = "Allow"
      Action   = ["dynamodb:GetItem", "dynamodb:PutItem"]
      Resource = aws_dynamodb_table.users.arn
    }]
  })
}
```

Checkov: CKV_AWS_1, CKV_AWS_63 | tfsec: aws-iam-no-policy-wildcards

### TF-LAMBDA-002: Function URL Without Auth

```bash
rg 'authorization_type\s*=\s*"NONE"' --type tf
```

#### Vulnerable

```hcl
resource "aws_lambda_function_url" "api" {
  function_name      = aws_lambda_function.api.function_name
  authorization_type = "NONE"  # Publicly accessible, bypasses API Gateway/WAF
}
```

#### Secure

```hcl
resource "aws_lambda_function_url" "api" {
  function_name      = aws_lambda_function.api.function_name
  authorization_type = "AWS_IAM"
  cors { allow_origins = ["https://app.example.com"] }
}
```

Checkov: CKV_AWS_258

### TF-LAMBDA-003: Plaintext Secrets in Environment Variables

```bash
rg '(PASSWORD|SECRET|API_KEY|PRIVATE_KEY|ACCESS_KEY|TOKEN|CREDENTIAL|AUTH)\s*=\s*"[^${}"]+' --type tf
rg '(DATABASE_URL|DB_URL|MONGO_URI|REDIS_URL|CONNECTION_STRING)\s*=\s*"[a-zA-Z]+://[^"]*:[^"]*@' --type tf
rg '=\s*"AKIA[0-9A-Z]{16}"' --type tf
```

#### Vulnerable

```hcl
resource "aws_lambda_function" "api" {
  environment {
    variables = {
      DB_PASSWORD = "supersecret123"
      API_KEY     = "sk-xxxxxxxxxxxx"
    }
  }
}
```

#### Secure

```hcl
resource "aws_lambda_function" "api" {
  kms_key_arn = aws_kms_key.lambda_env.arn
  environment {
    variables = {
      DB_PASSWORD_SSM_PATH = "/myapp/prod/db-password"
      API_KEY_SECRET_ARN   = aws_secretsmanager_secret.api_key.arn
    }
  }
}
```

Checkov: CKV_AWS_173

### TF-LAMBDA-004: Missing VPC Configuration

```bash
for f in $(rg -l 'resource\s+"aws_lambda_function"' --type tf); do
  if ! grep -q 'vpc_config' "$f"; then
    echo "MISSING vpc_config: $f"
  fi
done
```

Checkov: CKV_AWS_117

### TF-LAMBDA-005: Missing KMS Encryption for Environment Variables

```bash
for f in $(rg -l 'resource\s+"aws_lambda_function"' --type tf); do
  if grep -q 'environment' "$f" && ! grep -q 'kms_key_arn' "$f"; then
    echo "HAS environment BUT MISSING kms_key_arn: $f"
  fi
done
```

### TF-LAMBDA-006: Missing Dead Letter Queue

```bash
for f in $(rg -l 'resource\s+"aws_lambda_function"' --type tf); do
  if ! grep -q 'dead_letter_config' "$f"; then
    echo "MISSING dead_letter_config: $f"
  fi
done
```

Checkov: CKV_AWS_116

### TF-LAMBDA-007: Missing Reserved Concurrency

```bash
for f in $(rg -l 'resource\s+"aws_lambda_function"' --type tf); do
  if ! grep -q 'reserved_concurrent_executions' "$f"; then
    echo "MISSING reserved_concurrent_executions: $f"
  fi
done
```

Checkov: CKV_AWS_115

### TF-LAMBDA-008: Overly Permissive Resource Policy

```bash
rg 'principal\s*=\s*"\*"' --type tf
for f in $(rg -l 'resource\s+"aws_lambda_permission"' --type tf); do
  if ! grep -q 'source_arn' "$f"; then
    echo "MISSING source_arn in lambda_permission: $f"
  fi
done
```

### TF-LAMBDA-009: EOL Node.js Runtime

```bash
rg 'runtime\s*=\s*"nodejs(10|12|14|16|18)\.x"' --type tf
```

### TF-LAMBDA-010: Debug Mode Environment Variables

```bash
rg 'NODE_OPTIONS.*--inspect' --type tf
rg 'NODE_ENV["\s]*=\s*"(development|dev)"' --type tf
rg '"DEBUG"\s*[=:]\s*"(\*|true)"' --type tf
```

### TF-ECS-001: Privileged Container Mode

```bash
rg '"privileged"\s*:\s*true' --type tf
rg 'privileged\s*=\s*true' --type tf
```

#### Vulnerable

```hcl
resource "aws_ecs_task_definition" "app" {
  container_definitions = jsonencode([{
    name       = "app"
    image      = "my-app:latest"
    privileged = true
  }])
}
```

#### Secure

```hcl
container_definitions = jsonencode([{
  name       = "app"
  image      = "my-app:latest"
  privileged = false
}])
```

Checkov: CKV_AWS_97

### TF-ECS-002: Plaintext Secrets in Container Definitions

```bash
rg '"name"\s*:\s*"[^"]*(?i)(password|secret|key|token|credential)[^"]*"\s*,\s*"value"\s*:\s*"[^"$]+' --type tf
rg '"value"\s*:\s*"[a-zA-Z]+://[^"]*:[^"]*@' --type tf
rg '"value"\s*:\s*"AKIA[0-9A-Z]{16}"' --type tf
```

#### Secure

```hcl
container_definitions = jsonencode([{
  secrets = [
    { name = "DATABASE_PASSWORD", valueFrom = "arn:aws:ssm:us-east-1:123456789:parameter/prod/db-password" },
    { name = "API_KEY", valueFrom = "arn:aws:secretsmanager:us-east-1:123456789:secret:prod/api-key" },
  ]
}])
```

tfsec: aws-ecs-no-plaintext-secrets

### TF-ECS-003: Public IP Assignment

```bash
rg 'assign_public_ip\s*=\s*true' --type tf
```

### TF-ECS-004: ECS Exec Enabled in Production

```bash
rg 'enable_execute_command\s*=\s*true' --type tf
```

### TF-ECS-005: Debug Ports Exposed

```bash
rg '"(containerPort|hostPort)"\s*:\s*(9229|5858)' --type tf
```

Port 9229 is the Node.js inspector protocol port — exposing it allows remote code execution.

### TF-ECS-006: Missing Container Logging

```bash
for f in $(rg -l 'resource\s+"aws_ecs_task_definition"' --type tf); do
  if ! grep -q 'logConfiguration' "$f"; then
    echo "MISSING logConfiguration: $f"
  fi
done
```

### TF-ECS-007: Missing EFS In-Transit Encryption

```bash
rg 'transit_encryption\s*=\s*"DISABLED"' --type tf
for f in $(rg -l 'efs_volume_configuration' --type tf); do
  if ! grep -q 'transit_encryption' "$f"; then
    echo "MISSING transit_encryption: $f"
  fi
done
```

tfsec: aws-ecs-enable-in-transit-encryption

### TF-ECS-008: Missing Container Insights

```bash
for f in $(rg -l 'resource\s+"aws_ecs_cluster"' --type tf); do
  if ! grep -q 'containerInsights' "$f"; then
    echo "MISSING containerInsights: $f"
  fi
done
```

Checkov: CKV_AWS_65

### TF-GENERAL-001: Hardcoded AWS Credentials in Provider

```bash
rg 'AKIA[0-9A-Z]{16}' --type tf
rg 'access_key\s*=\s*"[^${}"]+' --type tf
rg 'secret_key\s*=\s*"[^${}"]+' --type tf
```

### TF-GENERAL-002: Secrets in terraform.tfvars

```bash
rg '(password|secret|key|token|credential|api_key|private_key)\s*=\s*"[^${}"]+' --glob '*.tfvars'
rg 'AKIA[0-9A-Z]{16}' --glob '*.tfvars'
```

### TF-GENERAL-003: Missing State File Encryption

```bash
for f in $(rg -l 'backend\s+"s3"' --type tf); do
  if ! grep -q 'encrypt' "$f"; then
    echo "MISSING encrypt in S3 backend: $f"
  fi
done
```

### TF-GENERAL-004: Missing Remote State Locking

```bash
for f in $(rg -l 'backend\s+"s3"' --type tf); do
  if ! grep -q 'dynamodb_table' "$f"; then
    echo "MISSING dynamodb_table (state locking): $f"
  fi
done
```

### TF-GENERAL-005: No Remote Backend

```bash
for f in $(rg -l 'terraform\s*{' --type tf); do
  if ! grep -q 'backend' "$f"; then
    echo "NO REMOTE BACKEND: $f"
  fi
done
```

### Terraform Tool Cross-Reference

| Pattern | Severity | Checkov | tfsec |
|---------|----------|---------|-------|
| TF-LAMBDA-001 IAM wildcards | Critical | CKV_AWS_1, CKV_AWS_63 | aws-iam-no-policy-wildcards |
| TF-LAMBDA-002 Function URL no auth | Critical | CKV_AWS_258 | -- |
| TF-LAMBDA-003 Plaintext secrets | Critical | CKV_AWS_173 | -- |
| TF-ECS-001 Privileged mode | Critical | CKV_AWS_97 | -- |
| TF-ECS-002 ECS plaintext secrets | Critical | -- | aws-ecs-no-plaintext-secrets |
| TF-GENERAL-001 Hardcoded credentials | Critical | CKV_AWS_41 | -- |
| TF-LAMBDA-005 Missing KMS | High | CKV_AWS_173 | -- |
| TF-LAMBDA-008 Wildcard principal | High | -- | -- |
| TF-ECS-003 Public IP | High | -- | -- |
| TF-ECS-004 ECS Exec enabled | High | -- | -- |
| TF-ECS-005 Debug ports | High | -- | -- |
| TF-ECS-007 EFS no encryption | High | -- | aws-ecs-enable-in-transit-encryption |
| TF-LAMBDA-004 Missing VPC | Medium | CKV_AWS_117 | -- |
| TF-LAMBDA-006 Missing DLQ | Medium | CKV_AWS_116 | -- |
| TF-LAMBDA-007 Missing concurrency | Medium | CKV_AWS_115 | -- |
| TF-ECS-006 Missing logging | Medium | -- | -- |
| TF-ECS-008 Missing insights | Medium | CKV_AWS_65 | -- |
| TF-GENERAL-003 State not encrypted | High | -- | -- |

---

## CloudFormation / SAM IaC Vulnerabilities (Lambda/ECS Node.js)

Scan `*.yml`, `*.yaml`, and `*.json` CloudFormation/SAM templates for infrastructure misconfigurations.

**Detection:** `find . \( -name "template.yaml" -o -name "template.yml" -o -name "sam.yaml" -o -name "*.template" \) -not -path "*/node_modules/*" 2>/dev/null`

### CFN-LAMBDA-001: Wildcard IAM Action/Resource

```bash
grep -rnE 'Action:\s*["\x27]?\*["\x27]?|"Action"\s*:\s*"\*"' --include="*.{yml,yaml,json,template}"
grep -rnE 'Resource:\s*["\x27]?\*["\x27]?|"Resource"\s*:\s*"\*"' --include="*.{yml,yaml,json,template}"
```

#### Vulnerable

```yaml
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      Policies:
        - PolicyDocument:
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'
```

#### Secure

```yaml
      Policies:
        - PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                Resource: !GetAtt UsersTable.Arn
```

cfn-nag: F3, F4

### CFN-LAMBDA-002: Lambda URL AuthType NONE

```bash
grep -rnE 'AuthType:\s*NONE|"AuthType"\s*:\s*"NONE"' --include="*.{yml,yaml,json,template}"
```

### CFN-LAMBDA-003: Hardcoded Secrets in Environment Variables

```bash
grep -rnEi "(PASSWORD|SECRET|API_KEY|APIKEY|TOKEN|PRIVATE_KEY|DB_PASS|AWS_ACCESS_KEY|AWS_SECRET|DATABASE_URL|CONNECTION_STRING):\s*['\"]?[A-Za-z0-9+/=_.@#$%^&*-]{8,}" --include="*.{yml,yaml}" | grep -v "!Ref\|!Sub\|!GetAtt\|Fn::\|resolve:ssm\|resolve:secretsmanager"
grep -rnE "AKIA[A-Z0-9]{16}" --include="*.{yml,yaml,json,template}"
```

#### Vulnerable

```yaml
      Environment:
        Variables:
          DB_PASSWORD: "SuperSecret123!"
          API_KEY: "sk-1234567890abcdef"
```

#### Secure

```yaml
      Environment:
        Variables:
          DB_PASSWORD: "{{resolve:ssm-secure:/myapp/db-password}}"
          API_KEY: "{{resolve:secretsmanager:myapp/api-key:SecretString:apiKey}}"
```

### CFN-LAMBDA-004: Missing VPC Configuration

```bash
grep -rnl "AWS::Lambda::Function" --include="*.{yml,yaml}" | while read f; do
  if ! grep -q "VpcConfig" "$f"; then echo "MISSING_VPC: $f"; fi
done
```

cfn-nag: W89

### CFN-LAMBDA-005: Missing DLQ

```bash
grep -rnl "AWS::Lambda::Function" --include="*.{yml,yaml}" | while read f; do
  if ! grep -q "DeadLetterConfig" "$f"; then echo "MISSING_DLQ: $f"; fi
done
```

### CFN-LAMBDA-006: Missing ReservedConcurrentExecutions

```bash
grep -rnl "AWS::Lambda::Function" --include="*.{yml,yaml}" | while read f; do
  if ! grep -q "ReservedConcurrentExecutions" "$f"; then echo "MISSING_CONCURRENCY: $f"; fi
done
```

cfn-nag: W92

### CFN-LAMBDA-007: Wildcard Lambda Permission Principal

```bash
grep -rnE "Type:\s*AWS::Lambda::Permission" --include="*.{yml,yaml}" -A 10 | grep -E 'Principal:\s*["\x27]?\*["\x27]?'
```

cfn-nag: F13

### CFN-LAMBDA-008: Missing KMS for Environment Variables

```bash
grep -rnl "AWS::Lambda::Function" --include="*.{yml,yaml}" | while read f; do
  if grep -q "Environment:" "$f" && ! grep -q "KmsKeyArn" "$f"; then
    echo "MISSING_KMS: $f"
  fi
done
```

### SAM-001: Missing Auth on API Events

```bash
grep -rnE "Type:\s*Api$" --include="*.{yml,yaml}" -A 10 | grep -v "Auth:"
grep -rnE "Type:\s*HttpApi$" --include="*.{yml,yaml}" -A 10 | grep -v "Auth:"
grep -rnE "Authorizer:\s*NONE" --include="*.{yml,yaml}"
```

#### Secure

```yaml
Globals:
  Api:
    Auth:
      DefaultAuthorizer: MyCognitoAuthorizer
```

### SAM-002: Permissive CORS

```bash
grep -rnE "AllowOrigin:\s*['\"]?\*['\"]?" --include="*.{yml,yaml}"
grep -rnE "Cors:\s*['\"]'\*'['\"]" --include="*.{yml,yaml}"
```

### SAM-003: HttpApi vs Api Security Differences

`AWS::Serverless::HttpApi` (HTTP API V2) lacks WAF support, request validation, and resource policies. Check HttpApi events have authorization configured.

```bash
grep -rnE "Type:\s*AWS::Serverless::HttpApi" --include="*.{yml,yaml}" -A 20 | grep -v "Authorizer\|Auth"
```

### SAM-004: Missing WAF on REST API

```bash
grep -rnl "AWS::Serverless::Api" --include="*.{yml,yaml}" | while read f; do
  if ! grep -qE "WAFv2::WebACLAssociation|WAF::WebACLAssociation" "$f"; then
    echo "NO_WAF: $f"
  fi
done
```

### SAM-005: Missing Access Log Configuration

```bash
grep -rnl "AWS::Serverless::Api" --include="*.{yml,yaml}" | while read f; do
  if ! grep -q "AccessLogSetting" "$f"; then echo "MISSING_ACCESS_LOG: $f"; fi
done
```

### CFN-ECS-001: Privileged Container

```bash
grep -rnEi "Privileged:\s*(true|True|TRUE)" --include="*.{yml,yaml}"
grep -rnE '"Privileged"\s*:\s*true|"privileged"\s*:\s*true' --include="*.{json,template}"
```

cfn-nag: W34

### CFN-ECS-002: Plaintext Secrets in ContainerDefinitions

```bash
grep -rnl "AWS::ECS::TaskDefinition" --include="*.{yml,yaml}" | while read f; do
  if grep -q "Environment:" "$f" && ! grep -q "Secrets:" "$f"; then
    echo "NO_SECRETS_PROP: $f"
  fi
done
```

#### Secure

Use the `Secrets` property with `ValueFrom` pointing to SSM Parameter Store or Secrets Manager ARNs.

### CFN-ECS-003: ECS Exec Enabled

```bash
grep -rnE "EnableExecuteCommand:\s*(true|True|TRUE)" --include="*.{yml,yaml}"
```

### CFN-ECS-004: Non-awsvpc Network Mode

```bash
grep -rnE "NetworkMode:\s*(host|bridge)" --include="*.{yml,yaml}"
```

### CFN-ECS-005: Public IP on Fargate Tasks

```bash
grep -rnE "AssignPublicIp:\s*ENABLED" --include="*.{yml,yaml}"
```

### CFN-ECS-006: Missing Logging Configuration

```bash
grep -rnl "AWS::ECS::TaskDefinition" --include="*.{yml,yaml}" | while read f; do
  if ! grep -q "LogConfiguration" "$f"; then echo "MISSING_LOGGING: $f"; fi
done
```

### CFN-ECS-007: ALB Without WAF

```bash
grep -rnl "AWS::ElasticLoadBalancingV2::LoadBalancer" --include="*.{yml,yaml}" | while read f; do
  if ! grep -q "WAFv2::WebACLAssociation\|WAF::WebACLAssociation" "$f"; then
    echo "NO_WAF: $f"
  fi
done
```

### CFN-ECS-008: Missing ReadonlyRootFilesystem

```bash
grep -rnl "AWS::ECS::TaskDefinition" --include="*.{yml,yaml}" | while read f; do
  if ! grep -q "ReadonlyRootFilesystem" "$f"; then echo "MISSING_READONLY_FS: $f"; fi
done
```

### CloudFormation Tool Cross-Reference

| Pattern | Severity | cfn-nag | AWS Config |
|---------|----------|---------|------------|
| CFN-LAMBDA-001 Wildcard IAM | Critical | F3, F4 | iam-policy-no-statements-with-full-access |
| CFN-LAMBDA-003 Hardcoded secrets | Critical | -- | -- |
| CFN-LAMBDA-007 Wildcard principal | Critical | F13 | lambda-function-public-access-prohibited |
| CFN-ECS-001 Privileged container | Critical | W34 | ecs-task-definition-nonprivileged |
| CFN-ECS-002 Plaintext secrets | Critical | -- | ecs-no-environment-secrets |
| CFN-LAMBDA-002 URL NONE auth | High | -- | lambda-function-public-access-prohibited |
| CFN-LAMBDA-008 Missing KMS | High | -- | -- |
| SAM-001 Missing API auth | High | -- | -- |
| CFN-ECS-003 ECS Exec enabled | High | -- | -- |
| CFN-ECS-004 Non-awsvpc | High | -- | ecs-awsvpc-networking-enabled |
| CFN-ECS-005 Public IP | High | -- | -- |
| CFN-ECS-006 Missing logging | High | -- | ecs-task-definition-log-configuration |
| CFN-ECS-007 ALB no WAF | High | -- | alb-waf-enabled |
| CFN-LAMBDA-004 Missing VPC | Medium | W89 | lambda-inside-vpc |
| CFN-LAMBDA-005 Missing DLQ | Medium | -- | lambda-dlq-check |
| CFN-LAMBDA-006 Missing concurrency | Medium | W92 | lambda-concurrency-check |
| SAM-002 Permissive CORS | Medium | -- | -- |
| CFN-ECS-008 Missing readonly FS | Medium | -- | ecs-containers-readonly-access |

---

## Serverless Framework Vulnerabilities

Scan `serverless.yml` / `serverless.yaml` configuration files for Serverless Framework-specific misconfigurations.

**Detection:** `find . \( -name "serverless.yml" -o -name "serverless.yaml" -o -name "serverless.ts" \) -not -path "*/node_modules/*" 2>/dev/null`

### SLS-001: Wildcard IAM Actions

```bash
grep -rnE "Action\s*:\s*['\"]?\*['\"]?" --include="*.{yml,yaml}" serverless.yml
```

#### Vulnerable

```yaml
provider:
  iam:
    role:
      statements:
        - Effect: Allow
          Action: '*'
          Resource: '*'
```

#### Secure

```yaml
provider:
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
          Resource: !GetAtt UsersTable.Arn
```

### SLS-002: Wildcard IAM Resources

```bash
grep -rnE "Resource\s*:\s*['\"]?\*['\"]?" --include="*.{yml,yaml}" serverless.yml
grep -rnE "(dynamodb|s3|sqs|sns|lambda|iam|sts|kms|secretsmanager|rds|ec2|logs):\*" --include="*.{yml,yaml}"
```

### SLS-003: Missing Per-Function IAM Roles

By default, Serverless Framework creates a single IAM role shared by all functions. A compromise of one function grants the combined permissions of all functions.

```bash
grep -rnE "serverless-iam-roles-per-function" --include="*.{yml,yaml}" serverless.yml
# v3+/v4 native per-function IAM
grep -rnE "^\s{4,}iam:" --include="*.{yml,yaml}" serverless.yml
```

#### Secure

```yaml
plugins:
  - serverless-iam-roles-per-function

functions:
  getUser:
    handler: src/getUser.handler
    iamRoleStatements:
      - Effect: Allow
        Action: [dynamodb:GetItem]
        Resource: !GetAtt UsersTable.Arn
```

### SLS-004: HTTP Endpoints Without Authorizer

```bash
# Count HTTP events vs authorizer references
HTTP_EVENTS=$(grep -c -E "(http|httpApi):" serverless.yml 2>/dev/null || echo 0)
AUTH_REFS=$(grep -c "authorizer" serverless.yml 2>/dev/null || echo 0)
```

### SLS-005: Overly Permissive CORS

```bash
grep -rnE "cors:\s*true" --include="*.{yml,yaml}"
grep -rnE "origin:\s*['\"]?\*['\"]?" --include="*.{yml,yaml}"
```

#### Vulnerable

```yaml
functions:
  getUsers:
    events:
      - http:
          path: /users
          method: get
          cors: true  # Access-Control-Allow-Origin: *
```

#### Secure

```yaml
          cors:
            origin: 'https://app.example.com'
            headers: [Content-Type, Authorization]
            allowCredentials: true
```

### SLS-006: Hardcoded Secrets in Environment Variables

```bash
grep -rnEi "(PASSWORD|SECRET|KEY|TOKEN|PRIVATE|CREDENTIAL)\s*:\s*['\"][^\${][^'\"]{4,}['\"]" --include="*.{yml,yaml}" serverless.yml
```

#### Vulnerable

```yaml
provider:
  environment:
    DB_PASSWORD: 'MyS3cretP@ssw0rd!'
    JWT_SECRET: 'super-secret-jwt-key-123'
```

#### Secure

```yaml
provider:
  environment:
    DB_PASSWORD: ${ssm:/myapp/${sls:stage}/db-password}
    JWT_SECRET: ${ssm:/aws/reference/secretsmanager/myapp/jwt-secret}
```

### SLS-007: Missing VPC Configuration

```bash
grep -rnE "^\s+vpc:" --include="*.{yml,yaml}" serverless.yml
grep -rnE "securityGroupIds:|subnetIds:" --include="*.{yml,yaml}" serverless.yml
```

### SLS-008: Stage-Specific Configuration Missing

```bash
grep -rnE "stage:\s*['\"]?(dev|development|test)['\"]?" --include="*.{yml,yaml}" serverless.yml
grep -rnE "\$\{sls:stage\}|\$\{opt:stage|\$\{self:provider\.stage\}" --include="*.{yml,yaml}" serverless.yml || echo "NO STAGE VARIABLE USAGE"
```

### SLS-009: Missing Throttling / Rate Limiting

```bash
grep -rnE "throttle:|burstLimit:|rateLimit:" --include="*.{yml,yaml}" serverless.yml
grep -rnE "serverless-api-gateway-throttling" --include="*.{yml,yaml}" serverless.yml
grep -rnE "reservedConcurrency:|provisionedConcurrency:" --include="*.{yml,yaml}" serverless.yml
```

### SLS-010: Function URL Without Authentication

```bash
grep -rnE "url:\s*true" --include="*.{yml,yaml}" serverless.yml
```

#### Vulnerable

```yaml
functions:
  api:
    handler: src/api.handler
    url: true  # AuthType: NONE — publicly accessible
```

#### Secure

```yaml
    url:
      authorizer: aws_iam
      cors:
        allowedOrigins: [https://app.example.com]
```

### SLS-011: WebSocket Routes Without Authorization

```bash
grep -rnE "route:\s*\\\$connect" --include="*.{yml,yaml}" -A 5 | grep -v "authorizer"
```

### SLS-012: serverless-offline in Production

```bash
grep -rnE "serverless-offline" --include="*.{yml,yaml}" serverless.yml
```

#### Secure

```yaml
# Conditionally load by stage
plugins: ${self:custom.plugins.${sls:stage}, self:custom.plugins.default}
custom:
  plugins:
    dev: [serverless-webpack, serverless-offline]
    default: [serverless-webpack]
```

### SLS-013: serverless-dotenv-plugin Exposing .env

```bash
grep -rnE "serverless-dotenv-plugin" --include="*.{yml,yaml}" serverless.yml
grep -rnE "useDotenv:\s*true" --include="*.{yml,yaml}" serverless.yml
grep -q "\.env" .gitignore 2>/dev/null || echo ".ENV NOT IN GITIGNORE"
```

### SLS-014: Missing Deployment Bucket Encryption

```bash
grep -rnE "deploymentBucket:" --include="*.{yml,yaml}" serverless.yml -A 10 | grep "serverSideEncryption" || echo "NO DEPLOYMENT BUCKET ENCRYPTION"
```

#### Secure

```yaml
provider:
  deploymentBucket:
    name: ${self:service}-${sls:stage}-deployments
    serverSideEncryption: aws:kms
    blockPublicAccess: true
```

### SLS-015: Deprecated Node.js Runtime

```bash
grep -rnE "runtime:\s*(nodejs12\.x|nodejs14\.x|nodejs16\.x)" --include="*.{yml,yaml}"
```

### SLS-016: Missing X-Ray Tracing

```bash
grep -rnE "tracing:" --include="*.{yml,yaml}" serverless.yml
grep -rnE "tracing:" --include="*.{yml,yaml}" -A 3 | grep -E "apiGateway:|lambda:"
```

### SLS-017: Missing API Gateway Access Logging

```bash
grep -rnE "logs:" --include="*.{yml,yaml}" serverless.yml -A 5
grep -rnE "accessLogging:" --include="*.{yml,yaml}" serverless.yml
```

### SLS-018: Missing WAF Integration

```bash
grep -rnE "waf\|WebACL\|web_acl\|serverless-associate-waf|AWS::WAFv2" --include="*.{yml,yaml}" serverless.yml
```

### SLS-019: Missing DLQ for Async Invocations

```bash
grep -rnE "onError:|deadLetterQueueArn:|DeadLetterConfig:|destinations:" --include="*.{yml,yaml}" serverless.yml
```

### Serverless Framework Quick Reference

| ID | Finding | Severity |
|----|---------|----------|
| SLS-001 | Wildcard IAM Actions | Critical |
| SLS-002 | Wildcard IAM Resources | Critical |
| SLS-004 | HTTP endpoints without authorizer | Critical |
| SLS-006 | Hardcoded secrets in environment | Critical |
| SLS-010 | Function URL without auth | Critical |
| SLS-003 | Missing per-function IAM roles | High |
| SLS-005 | Overly permissive CORS | High |
| SLS-008 | Dev config in production | High |
| SLS-009 | Missing throttling/rate limiting | High |
| SLS-011 | WebSocket routes without auth | High |
| SLS-012 | serverless-offline in production | High |
| SLS-013 | serverless-dotenv-plugin risks | High |
| SLS-015 | Deprecated Node.js runtime | High |
| SLS-018 | Missing WAF integration | High |
| SLS-007 | Missing VPC configuration | Medium |
| SLS-014 | Missing deployment bucket encryption | Medium |
| SLS-016 | Missing X-Ray tracing | Medium |
| SLS-017 | Missing access logging | Medium |
| SLS-019 | Missing DLQ for async | Medium |
